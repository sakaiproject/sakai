<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<html>
<head>

<title>Database Configuration</title>
 <link href="styles/posu.css" rel="stylesheet" type="text/css" />
 <link href="styles/styles3.css" rel="stylesheet" type="text/css" />
</head>

<body>

<div id="frame">

	<div id="contentheader">
	<a href="http://www.sakaiproject.org/">
<img src="images/logoslate160x89.jpg" alt="Sakai Logo"
 border="0" /></a>
	</div>

	<div id="contentleft">

	<div id="bar">
	  &nbsp;
	  <!--END BAR-->
	</div>

<div class="pad">
<h2>Installation Guide<br>Table of Contents</h2>
<ol>
<li>
<a href="InstallGuide.html">Installation Overview</a></li>
<ul class="toc">
	<li><a href="InstallGuide.html#choose">1.1 Choose an Install Type</a></li>
	<li><a href="InstallGuide.html#demo">1.2 Demo Installation</a></li>
	<li><a href="InstallGuide.html#binary">1.3 Binary Installation</a></li>
	<li><a href="InstallGuide.html#overview">1.4 Source Install Phases</a></li>
	<li><a href="InstallGuide.html#migrating">1.5 Migrating from a Previous Release</a></li>
</ul>
<li>
<a href="buildenv.html">Set Up Build Environment</a>
<ul class="toc">
  <li><a href="buildenv.html#verify">2.1 Verify Java installation</a></li>
  <li><a href="buildenv.html#set">2.2 Set environment variables</a></li>
  <li><a href="buildenv.html#tomcat">2.3 Install
  Tomcat</a></li>
  <li><a href="buildenv.html#configurationtc">2.4 Configure Tomcat</a></li>
  <li><a href="buildenv.html#maven">2.5 Install Maven</a></li>
  <li><a href="buildenv.html#configurationm">2.6 Configure Maven</a></li>
  <li><a href="buildenv.html#testm">2.7 Test Maven</a></li>
  </li>
 </ul>
<li>
<a href="build.html">
  Build and Deploy Sakai</a>
<ul class="toc">
<li><a href="build.html#download">3.1 Download source</a></li>
  <li><a href="build.html#unpack">3.2 Unpack source</a></li>
  <li><a href="build.html#runmaven">3.3 Run maven</a></li>
</ul>
</li>

<li>
  <a href="postconfig.html">Post-Installation Configuration</a>
<ul class="toc">
<li><a href="postconfig.html#folder">4.1 Create sakai folder <br />
for properties files</a> </li>
  <li> <a href="postconfig.html#properties">4.2 The
sakai.properties file</a> </li>
  <li><a href="postconfig.html#personalize">4.3 Personalizing Sakai</a> </li>
  <li><a href="postconfig.html#email">4.4 Email configuration</a> </li>
  <li><a href="postconfig.html#jvm">4.5 JVM tuning</a> </li>
  <li><a href="postconfig.html#test">4.6 Test Sakai</a> </li>
</ul>
</li>

<li>
  <a href="dbconfig.html">Database Configuration</a>
<ul class="toc">
  <li><a href="dbconfig.html#updating">5.1 Migrating from a Previous Version</a></li>
  <li><a href="dbconfig.html#deployd">5.2 Deploy drivers</a> </li>
  <li><a href="dbconfig.html#create">5.3 Create Sakai database and user</a> </li>
  <li><a href="dbconfig.html#sproperties">5.4 Database Properties</a> </li>
</ul>
</li>
<li>
  <a href="tshoot.html">Troubleshooting</a>
<ul class="toc">
  <li><a href="tshoot.html#common">6.1 Common Issues</a> </li>
  <li><a href="tshoot.html#maven">6.2 Working with Maven</a> </li>
  <li><a href="tshoot.html#logs">6.3 Tomcat logs</a> </li>
</li>
</ul>
</li>
</ol>
<p>&nbsp;</p>


    <!--END PAD-->
  </div>

   <!--END LEFT-->
</div>


<div class="pad2">


<h1>5. Database Configuration</h1>
  <a name="deployd"></a>

  <a name="updating"></a>
  <h2>5.1 Migrating from a Previous Version</h2>
  <p>There are database schema changes between 2.1.1 and 2.1.2, and the update scripts to be applied - in distinct versions for mysql and Oracle, respectively - are found in the <b>docs/updating</b> folder of the release or on subversion:</p>

<p>MySQL: <a href="https://source.sakaiproject.org/svn/sakai/tags/sakai_2-1-2/docs/updating/sakai_2_1_1-2_1_2_mysql_conversion.sql">sakai_2_1_1-2_1_2_mysql_conversion.sql</a><br />

    Oracle: <a href="https://source.sakaiproject.org/svn/sakai/tags/sakai_2-1-2/docs/updating/sakai_2_1_1-2_1_2_oracle_conversion.sql">sakai_2_1_1-2_1_2_oracle_conversion.sql</a></p>

<p>In the same directory you'll also find conversion scripts for earlier Sakai versions.  Migration from an earlier version will require the successive application of all intermediate update scripts. You cannot, for example, move from 2.0.1 to 2.1.1 by applying a single DB script. You will need to move first from 2.0.1 to 2.1.0, and then to 2.1.1.</p>

  <br/><table bgcolor="#ccddff" border="0" cellpadding="2" cellspacing="2">
         <tbody>
           <tr>

             <th>Examine Before Using</th>
           </tr>
           <tr>
             <td class="white">As a general rule, be sure to read through these conversion scripts before applying them.  The 2.0-2.1 script, in particular, includes notes about roles that may spare you a potential headache if you've been running 2.0 in production.</td>
           </tr>
         </tbody>
    </table>

    <h2>5.2 Deploy Drivers</h2>
    <p>The supported production-grade databases include MySQL 4.1+ and Oracle 9i+. The version of the JDBC driver (or connector) is also important. For MySQL the 3.1.12 connector should be used, while for Oracle the 10g driver should be used, even if the database is version 9i.</p><br/>
    <table bgcolor="#ccddff" border="0" cellpadding="2" cellspacing="2">
	             <tbody>
	               <tr>
	                 <th>Driver Versions</th>
	               </tr>
	               <tr>
	                 <td class="white"><p>Database driver versions are a common source of problems. It's worth emphasizing again that <b>the Oracle 10g driver must be used</b> for Sakai installations running against Oracle, even when Oracle 9i is the database version.</p>
	                 <p>Problems have been reported for both the 3.1.10 and 3.1.11 MySQL drivers. 3.1.12 is the recommended version.</p></td>
	               </tr>
	             </tbody>
    </table>
    <p>You need to have appropriate JDBC drivers for your database installed in your $CATALINA_HOME/common/lib directory, and they are available from the official sites for both <a href="http://www.oracle.com/technology/software/tech/java/sqlj_jdbc/index.html">Oracle</a> and <a href="http://dev.mysql.com/downloads/connector/j/3.1.html">MySQL</a>.</p>
    <p></p>

    <a name="create"></a>

    <p><h2>5.3 Create Sakai Database and User</h2></p>
    <br/>A Sakai database and
privileged user
must be prepared for Sakai's use. Consult your database documentation
for details, but here are sample commands for MySQL:</p>
<pre><span class="code">C:\sakai\reference\sql\legacy\mysql\&gt;
mysql -u root -p<br>Enter password: ******
Welcome to the MySQL monitor. Commands end with ; or \g.

Your MySQL connection id is 51 to server version: 4.1.5-gamma-nt

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt; create database sakai default character set utf8;
Query OK, 1 row affected (0.00 sec)

mysql&gt; grant all on sakai.* to sakaiuser@'localhost' identified by 'password';<br>Query OK, 0 rows affected (0.00 sec

mysql&gt; grant all on sakai.* to sakaiuser@'127.0.0.1' identified by 'password';<br>Query OK, 0 rows affected (0.00 sec)

mysql&gt; quit </span></pre>

    <a name="sproperties"></a>

    <p><h2>5.4 Database Properties</h2></p>
<table bgcolor="#ccddff" border="0" cellpadding="2" cellspacing="2">
	             <tbody>
	               <tr>
	                 <th>Significant Change to DB configuration for 2.1</th>
	               </tr>
	               <tr>
	                 <td class="white">The process of setting database properties has changed significantly from previous versions of Sakai.  Specifically, the placeholder.properties file in its entirety has been deprecated, and all configuration settings are now made in sakai.properties.</td>
	               </tr>
	             </tbody>
    </table>
    <br/>There are settings in
sakai.properties that also define the database technology and
connection information. Appropriate sakai.properties settings for
Oracle and MySQL, respectively, are listed below (although some pieces
will of course need to be altered appropriately for your installation):</p>
    <ul>
      <li>
        <strong>Oracle:</strong>
<pre>vendor@org.sakaiproject.service.framework.sql.SqlService=oracle<br>driverClassName@javax.sql.BaseDataSource=oracle.jdbc.driver.OracleDriver<br>url@javax.sql.BaseDataSource=jdbc:oracle:thin:@your.oracle.dns:1521:SID<br>username@javax.sql.BaseDataSource=[database user name]<br>password@javax.sql.BaseDataSource=[password]<br>hibernate.dialect=net.sf.hibernate.dialect.Oracle9Dialect<br>auto.ddl=true<br>validationQuery@javax.sql.BaseDataSource=select 1 from DUAL<br>defaultTransactionIsolationString@javax.sql.BaseDataSource=TRANSACTION_READ_COMMITTED</pre>
      </li>
      <table bgcolor="#ccddff" border="0" cellpadding="2" cellspacing="2">
	  	             <tbody>
	  	               <tr>
	  	                 <th>Oracle performance</th>
	  	               </tr>
	  	               <tr>
	  	                 <td class="white">Oracle may have performance problems with some of the SQL settings
that work for HSQL and perhaps even for MySQL. By default, Oracle
should be set to the proper settings automatically; setting it with each
use may affect performace. In addition, validating the connection on
each transaction caused problems in at least one large production
environment (University of Michigan). Sakai installations using
Oracle should strongly consider the following settings in
sakai.properties to avoid these problems:

<pre># For improved Oracle performance (from the University of Michigan)
validationQuery@javax.sql.BaseDataSource=
defaultTransactionIsolationString@javax.sql.BaseDataSource=
testOnBorrow@javax.sql.BaseDataSource=false</pre>

This unsets the first two values and overrides the settings that are
in the base (kernel) sakai.properties file.</td>
	  	               </tr>
	  	             </tbody>
    </table>
      <li>
        <strong>MySQL:</strong>
<pre>vendor@org.sakaiproject.service.framework.sql.SqlService=mysql<br>driverClassName@javax.sql.BaseDataSource=com.mysql.jdbc.Driver<br>url@javax.sql.BaseDataSource=jdbc:mysql://127.0.0.1:3306/sakai?useUnicode=true&amp;characterEncoding=UTF-8<br>username@javax.sql.BaseDataSource=[database user name]<br>password@javax.sql.BaseDataSource=[password]<br>hibernate.dialect=net.sf.hibernate.dialect.MySQLDialect<br>auto.ddl=true<br>validationQuery@javax.sql.BaseDataSource=select 1 from DUAL<br>defaultTransactionIsolationString@javax.sql.BaseDataSource=TRANSACTION_READ_COMMITTED</pre>
      </li>
          </ul>

      <table bgcolor="#ccddff" border="0" cellpadding="2" cellspacing="2">
	  	  	             <tbody>
	  	  	               <tr>
	  	  	                 <th>Oracle Change for Tests&Quizzes</th>
	  	  	               </tr>
	  	  	               <tr>
	  	  	                 <td class="white">If you're running Oracle and using <b>auto.ddl</b> to create tables, you should check the data type of the "MEDIA" column in the SAM_MEDIA_T table. Hibernate tries to choose the right data type for this field, but has a habit of choosing the wrong one for Oracle.</p>

<ul>The correct types for each database are:

<li>HSQLDB --> varbinary</li>
<li>Oracle --> blob</li>
<li>MySQL --> longblob</li>
</ul>

<p>If you need to change this type for your database, this will also involve finding the primary key constraint, dropping it and then recreating it. Contact your local DBA for further information on making this change.</p>

<p>Below is some sample Oracle SQLplus output to better illustrate (SYS_C0064435 is the example constraint; replace it with yours): </p>

	  <pre>SQL> alter table SAM_MEDIA_T modify MEDIA BLOB;

Table altered.

SQL> select constraint_name from user_constraints where table_name='SAM_MEDIA_T'
and CONSTRAINT_TYPE='P';

CONSTRAINT_NAME
------------------------------
SYS_C0064435

SQL> alter table sam_media_t drop constraint SYS_C0064435;

Table altered.

SQL> alter table SAM_MEDIA_T add constraint SYS_C0064435 primary key (MEDIAID);

Table altered.

SQL> desc SAM_MEDIA_T;

[table with BLOB type]

SQL> select constraint_name from user_constraints where table_name='SAM_MEDIA_T'
and CONSTRAINT_TYPE='P';

CONSTRAINT_NAME
------------------------------
SYS_C0064435

SQL> commit;

Commit complete.</pre></td>
	  	  	               </tr>
	  	  	             </tbody>
    </table>

    <a name="dbconfig"></a>

<!--END CONTENT-->
</div>
</div>
<br clear="all" /><!-- without this little <br /> NS6 and IE5PC do not stretch the frame div down to encopass the content DIVs -->
  <!--END FRAME-->
</div>
</body>
</html>
