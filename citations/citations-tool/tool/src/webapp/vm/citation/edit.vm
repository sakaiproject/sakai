## sakai_citation-edit.vm -- use with CitationHelperAction.buildEditPanelContext()
## results handled by CitationHelperAction.doReviseCitation()
## cancel handled by CitationHelperAction.doList()
##
#macro(getFieldValue $field $oneValue $index)
	#if("shorttext" == "$!{field.valueType}")
		<input name="$!{field.identifier}$index" id="$!{field.identifier}$index" value="$!{oneValue}" type="text" size="50" />
	#elseif("number" == "$!{field.valueType}")
		<input name="$!{field.identifier}$index" id="$!{field.identifier}$index" value="$!{oneValue}" type="text" size="20" />
	#elseif("longtext" == "$!{field.valueType}")
		<textarea name="$!{field.identifier}$index" id="$!{field.identifier}$index" cols="50" rows="4">$!{oneValue}</textarea>
	#elseif("date" == "$!{field.valueType}")
		<input name="$!{field.identifier}$index" id="$!{field.identifier}$index" value="$!{oneValue}" type="text" size="20" />
	#end	
#end
#macro(getMultivalued $field $multiValues $count)
	<div id="div_$!{field.identifier}">
		<table>
			#if($multiValues && ($multiValues.size() > 0))
				#set($index = 0)
				#foreach($singleValue in $multiValues)
					<tr>
						<td>
							#getFieldValue($!field "$!singleValue" $!index)
						</td>
					</tr>
					#set($index = $index + 1)
				#end
			#else
				#set($index = 1)
				<tr>
					<td>
						#getFieldValue($field "" "0")
					</td>
				</tr>
			#end
			<tr>
				<td>
					<a href="#" onclick="javascript:getAnother('${DEFAULT_TEMPLATE.identifier}', ${count})">Add another</a>
				</td>
			</tr>
		</table>
	</div>
	<input type="hidden" name="$!{field.identifier}_count" id="$!{field.identifier}_count" value="$index" />
#end

#set($default = "")
#if($!DEFAULT_TEMPLATE)#set($default = "$!DEFAULT_TEMPLATE.identifier")#end

<script type="text/javascript" src="#libraryLink('js/jquery-1.1.2.js')">
</script>
<script type="text/javascript" src="/sakai-citations-tool/js/citationscript.js">
</script>

<div class="indnt1" class="portletBody">
	<div class="indnt1" style="border: 3px solid red; display: none;" id="hiddenMessage">
		<div style="margin: 10px 10px 10px 10px;">
			<h3>
				$tlang.getString("title.close")
			</h3>
			<h4>
				$tlang.getString("subtitle.close")
			</h4>
			<p class="act">
				<input type="button" name="Close" id="Close" value="$tlang.getString("button.close")" onclick="window.close();" />
			</p>
		</div>
	</div>
	<div class="indnt1">
		<h3>$tlang.getString("title.edit")</h3>

		<p class="instruction">$tlang.getFormattedMessage( "instr.edit", $instrArgs )</p>
		<p class="instruction">$tlang.getString( "instr.edit.sub" )</p>
		
		<p class="act">
			<input class="active" type="button" name="Save" id="Save"
			 value="$tlang.getString("submit.edit")"
			 onclick="document.getElementById('sakai_action').value='doReviseCitation'; submitform('$FORM_NAME');"
			/>
			<input type="button" name="Cancel" id="Cancel"
			  value="$tlang.getString("cancel.edit")"
			  onclick="document.getElementById('sakai_action').value='doList'; submitform('$FORM_NAME');"
			/>
		</p>
		
		<form name="$FORM_NAME" id="$FORM_NAME" method="post" action="#toolForm("CitationHelperAction")">
			<input name="sakai_action" id="sakai_action" value="doReviseCitation" type="hidden" />
			<p class="shorttext">
				<label for="type">
					<strong>$tlang.getString("type.select")</strong>
				</label>
				<select name="type" id="type_selector" onchange="changeSchema(this);">
					#foreach($template in $TEMPLATES)
						<option value="$template.identifier"#if("$template.identifier" == "$default") selected="selected"#end>
							$tlang.getString("type.$!{template.identifier}")
						</option>
					#end
				</select>
			</p>
			<div id="div_$!FORM_NAME">
				#set($count = 0)
				#foreach($field in $DEFAULT_TEMPLATE.fields)
					#set($currentValue = "")
					#if($!{citation.getCitationProperty("$field.identifier")})
						#set($currentValue = $!{citation.getCitationProperty("$field.identifier")} )
					##elseif($!{field.defaultValue})
						##set($currentValue = $!{field.defaultValue})
					#end
					<p class="shorttext">
						#if ($field.isRequired())
							<span class="reqStar">*</span>
						#end
						#if($field.isMultivalued())
							<label for="${field.identifier}0">
								<strong>$tlang.getString("$!{DEFAULT_TEMPLATE.identifier}.$!{field.identifier}")</strong>
							</label>
							#getMultivalued($field $currentValue "$!count")
						#else
							<label for="$field.identifier">
								<strong>$tlang.getString("$!{DEFAULT_TEMPLATE.identifier}.$!{field.identifier}")</strong>
							</label>
							#getFieldValue($field "$!currentValue" "")
						#end						
					</p>
					#set($count = $count + 1)
				#end
			</div>
			<div id="url_div" class="shorttext">
				<label>
					<strong>$tlang.getString("title.link")</strong>
				</label>
				<table id="nextTable">
					#set($count = 0)
					#if($citation.hasCustomUrls())
						#foreach($urlId in $citation.customUrlIds)
							<tr>
								<td>
									<label for="url_${count}">
										$tlang.getString("url.link")
									</label>
								</td>
								<td>
									<input name="url_$count" id="url_$count" value="$!{citation.getCustomUrl("$urlId")}" type="text" size="50" />
								</td>
							</tr>
							<tr>
								<td>
									<label for="label_${count}">
										$tlang.getString("label.link")
									</label>
								</td>
								<td>
									<input name="label_$count" id="label_$count" value="$!{citation.getCustomUrlLabel("$urlId")}" type="text" size="20" />
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<input type="hidden" name="urlid_$count" id="urlid_$count" value="$!urlId" />
									<hr />
								</td>
							</tr>
							#set($count = $count + 1)
						#end
					#else
						<tr>
							<td>
								<label for="url_${count}">
									$tlang.getString("url.link")
								</label>
							</td>
							<td>
								<input name="url_$count" id="url_$count" value="" type="text" size="50" />
							</td>
						</tr>
						<tr>
							<td>
								<label for="label_${count}">
									$tlang.getString("label.link")
								</label>
							</td>
							<td>
								<input name="label_$count" id="label_$count" type="text" size="20" />
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="hidden" name="urlid_$count" id="urlid_$count" value="" />
								<hr />
							</td>
						</tr>
						#set($count = $count + 1)
					#end
					<tr>
						<td colspan="2">
							<a href="#" onclick="javascript:addUrl();">Add another</a>
						</td>
					</tr>
				</table>
			</div>
			<input type="hidden" name="url_count" id="url_count" value="$count" />
	 		<p class="act">
				<input class="active" type="button" name="Save" id="Save"
				  value="$tlang.getString("submit.edit")"
				  onclick="document.getElementById('sakai_action').value='doReviseCitation'; submitform('$FORM_NAME');"
				/>
				<input type="button" name="Cancel" id="Cancel"
				  value="$tlang.getString("cancel.edit")"
				  onclick="document.getElementById('sakai_action').value='doList'; submitform('$FORM_NAME');"
				/>
	    	</p>
		</form>
		<div id="scratch_space">
		</div>
	</div>
</div>

<script type="text/javascript">
	var templates = new Array();
	var templateIdentifiers = new Array();
	var defaultTemplate = "$DEFAULT_TEMPLATE.identifier";
	#foreach($template in $TEMPLATES)
	
		templateIdentifiers[templateIdentifiers.length] = "$template.identifier";
		templates["$template.identifier"] = new Array();
		templates["$template.identifier"]["label"] = "$tlang.getString("type.$!{template.identifier}")";
		templates["$template.identifier"]["fields"] = new Array();
		#set($index = 0)
		#foreach($field in $template.fields)
			templates["$template.identifier"][$index] = new Object();
			templates["$template.identifier"][$index].identifier = "$!{field.identifier}";
			templates["$template.identifier"][$index].label = "$tlang.getString("$!{template.identifier}.$!{field.identifier}")"
			templates["$template.identifier"][$index].description = "$!{field.description}";
			templates["$template.identifier"][$index].minCardinality = $!{field.minCardinality};
			templates["$template.identifier"][$index].maxCardinality = $!{field.maxCardinality};
			templates["$template.identifier"][$index].defaultValue = "$!{field.defaultValue}";
			templates["$template.identifier"][$index].isRequired = $field.isRequired();
			templates["$template.identifier"][$index].valueType = "$!{field.valueType}";
			#set($index = $index + 1)
		#end
	#end
	
	var currentValues = new Array();
	
    // resize frame on document ready
    function heavyResize() {
      var frame = parent.document.getElementById( window.name );
      
      if( frame ) {
        var clientH = document.body.clientHeight + 50;
        $( frame ).height( clientH );
      }
    }
	
	function changeSchema(type_element)
	{
		var form_div = document.getElementById("div_$!FORM_NAME");
		var type = type_element.value;
		var fields = document.getElementsByTagName("input");
		
		for(var i = 0; i < fields.length; i++)
		{
			if(fields[i].value)
			{
				currentValues[ fields[i].id ] = fields[i].value;
			}
		}
		
		var html = " ";
		
		for(var t = 0; t < templates[type].length; t++)
		{
			html += '<p class="shorttext">\n';
			if(templates[type][t].isRequired)
			{						 
				html += '<span class="reqStar">*</span>\n';
			}
			if(templates[type][t].maxCardinality > 1)
			{
				html += '<label for="' + templates[type][t].identifier + '0">\n' + templates[type][t].label + '\n</label>\n';
				html += getMultivalued(type, t);
			}
			else
			{
				html += '<label for="' + templates[type][t].identifier + '">\n' + templates[type][t].label + '\n</label>\n';
				html += getValue(type, t, "");
			}
			html += "</p>\n";
		}
		form_div.innerHTML = html;
	}
	function getValue(type, t, index)
	{
		var html = "";
		if("shorttext" == templates[type][t].valueType)
		{
			html += '<input name="' + templates[type][t].identifier + index + '" id="' 
					+ templates[type][t].identifier + index + '" type="text" size="50" ';
			if(currentValues[templates[type][t].identifier + index])
			{
				html += 'value="' + currentValues[templates[type][t].identifier + index] + '" ';
			}
			html += '/>\n';
		}
		else if("number" == templates[type][t].valueType)
		{
			html += '<input name="' + templates[type][t].identifier + index + '" id="' 
					+ templates[type][t].identifier + index + '" type="text" size="20" ';
			if(currentValues[templates[type][t].identifier])
			{
				html += 'value="' + currentValues[templates[type][t].identifier + index] + '" ';
			}
			html += '/>\n</p>\n';
		}
		else if("longtext" == templates[type][t].valueType)
		{
			html += '<textarea name="' + templates[type][t].identifier + index + '" id="'
					 + templates[type][t].identifier + index + '" cols="50" rows="4">'; 
			if(currentValues[templates[type][t].identifier + index])
			{
				html += currentValues[templates[type][t].identifier + index] ;
			}
			html += "</textarea>\n</p>\n";
		}

		return html;
	}
	function getMultivalued(type, t)
	{
		var identifier = templates[type][t].identifier;
		var count = 1;
		var count_item = document.getElementById(identifier + "_count");
		if(count_item)
		{
			count = count_item.value;
		}
				
		var html = "<div id=\"div_" + identifier + "\">\n<table class=\"multiAdded\">\n";
		for(var i = 0; i < count; i++)
		{
			html += "<tr>\n<td>\n" + getValue(type, t, i) + "</td>\n</tr>\n";
		}
		html += "<tr>\n<td>\n<a href=\"#\">Add another</a>\n</td>\n</tr>\n</table>\n</div>\n"
				+ "<input type=\"hidden\" name=\"" + identifier + "_count\" id=\"" + identifier 
				+ "_count\" value=\"" + count + "\" />\n";
		
		return html;
	}
	function getAnother(type, t)
	{
		var identifier = templates[type][t].identifier;
		var div = document.getElementById("div_" + identifier);
		var counter = document.getElementById(identifier + "_count");
		var count = 1 + parseInt(counter.value);
		
		var html = "<table class=\"getAnother\">\n";
		for(var i = 0; i < count; i++)
		{
			var oldElement = document.getElementById(identifier + i);
			if(oldElement && oldElement.value)
			{
				currentValues[templates[type][t].identifier + i] = oldElement.value;
			}
			html += "<tr>\n<td>\n" + getValue(type, t, i) + "</td>\n</tr>\n";
		}
		html += '<tr>\n<td>\n<a href="#" onclick="javascript:getAnother(\'' + type + '\', \'' + t + '\')">Add another</a>\n</td>\n</tr>\n</table>\n';
		
		div.innerHTML = html;
		counter.value = count;
		
		resizeFrame();
		
		return false;
	}
	function addUrl()
	{
		var div = document.getElementById("url_div");
		var counter = document.getElementById("url_count");
		var count = 1 + parseInt(counter.value);
		
		var html = "<label>\n$tlang.getString("title.link")\n</label>\n<table class=\"addUrl\">\n";
		for(var i = 0; i < count; i++)
		{
			var label = document.getElementById("label_" + i);
			var url = document.getElementById("url_" + i);
			var urlid = document.getElementById("urlid_" + i);
			
			if(label && label.value)
			{
				currentValues["label_" + i] = label.value;
			}
			else
			{
				currentValues["label_" + i] = "";
			}
			
			if(url && url.value)
			{
				currentValues["url_" + i] = url.value;
			}
			else
			{
				currentValues["url_" + i] = "";
			}
			
			if(urlid && urlid.value)
			{
				currentValues["urlid_" + i] = urlid.value;
			}
			else
			{
				currentValues["urlid_" + i] = "";
			}
			
			html += "<tr>\n<td>\n<label for=\"url_" + i + "\">\n$tlang.getString("url.link")\n</label>\n</td>\n"
						+ "<td>\n<input name=\"url_" + i + "\" id=\"url_" + i + "\" value=\"" + currentValues["url_" + i] + "\" type=\"text\" size=\"50\" />\n</td>\n</tr>\n"
						+ "<tr>\n<td>\n<label for=\"label_" + i + "\">\n$tlang.getString("label.link")\n</label>\n</td>\n"
						+ "<td>\n<input name=\"label_" + i + "\" id=\"label_" + i + "\" value=\"" + currentValues["label_" + i] + "\" type=\"text\" size=\"20\" />\n</td>\n</tr>\n"
						+ "<tr>\n<td colspan=\"2\">\n<hr />\n" 
						+ "<input name=\"urlid_" + i + "\" id=\"urlid_" + i + "\" value=\"" + currentValues["urlid_" + i] + "\" type=\"hidden\" />\n"
						+ "</td>\n</tr>\n";
		}
		html += '<tr>\n<td colspan=\"2\">\n<a href="#" onclick="javascript:addUrl();">Add another</a>\n</td>\n</tr>\n</table>\n';
		
		div.innerHTML = html;
		counter.value = count;
		
		resizeFrame();
		
		return false;
	}
</script>
<script type="text/javascript">	
	function submitform(id)
	{
		var theForm = document.getElementById(id);
		if(theForm && theForm.onsubmit)
		{
			theForm.onsubmit();
		}
		if(theForm && theForm.submit)
		{
			theForm.submit();
		}
	}
</script>
