var fluid_1_5=fluid_1_5||{};!function($,fluid){"use strict";fluid.orientation={HORIZONTAL:4,VERTICAL:1},fluid.rectSides={4:["left","right"],1:["top","bottom"],8:"top",12:"bottom",2:"left",3:"right"},fluid.position={BEFORE:-1,AFTER:1,INSIDE:2,REPLACE:3},fluid.direction={NEXT:1,PREVIOUS:-1,UP:8,DOWN:12,LEFT:2,RIGHT:3},fluid.directionSign=function(direction){return direction===fluid.direction.UP||direction===fluid.direction.LEFT?fluid.direction.PREVIOUS:fluid.direction.NEXT},fluid.directionAxis=function(direction){return direction===fluid.direction.LEFT||direction===fluid.direction.RIGHT?0:1},fluid.directionOrientation=function(direction){return fluid.directionAxis(direction)?fluid.orientation.VERTICAL:fluid.orientation.HORIZONTAL},fluid.keycodeDirection={up:fluid.direction.UP,down:fluid.direction.DOWN,left:fluid.direction.LEFT,right:fluid.direction.RIGHT},fluid.registerNamespace("fluid.dom"),fluid.dom.moveDom=function(source,target,position){source=fluid.unwrap(source),target=fluid.unwrap(target);var scan;if(position===fluid.position.INSIDE)target.appendChild(source);else if(position===fluid.position.BEFORE){for(scan=target.previousSibling;;scan=scan.previousSibling)if(!scan||!fluid.dom.isIgnorableNode(scan)){scan!==source&&(fluid.dom.cleanseScripts(source),target.parentNode.insertBefore(source,target));break}}else if(position===fluid.position.AFTER){for(scan=target.nextSibling;;scan=scan.nextSibling)if(!scan||!fluid.dom.isIgnorableNode(scan)){scan!==source&&(fluid.dom.cleanseScripts(source),fluid.dom.insertAfter(source,target));break}}else fluid.fail("Unrecognised position supplied to fluid.moveDom: "+position)},fluid.dom.normalisePosition=function(position,samespan,targeti,sourcei){return position===fluid.position.REPLACE&&(position=samespan&&targeti>=sourcei?fluid.position.AFTER:fluid.position.BEFORE),position},fluid.dom.permuteDom=function(element,target,position,sourceelements,targetelements){element=fluid.unwrap(element),target=fluid.unwrap(target);var sourcei=$.inArray(element,sourceelements);-1===sourcei&&fluid.fail("Error in permuteDom: source element "+fluid.dumpEl(element)+" not found in source list "+fluid.dumpEl(sourceelements));var targeti=$.inArray(target,targetelements);-1===targeti&&fluid.fail("Error in permuteDom: target element "+fluid.dumpEl(target)+" not found in source list "+fluid.dumpEl(targetelements));var samespan=sourceelements===targetelements;position=fluid.dom.normalisePosition(position,samespan,targeti,sourcei);var oldn={};oldn[fluid.position.AFTER]=element.nextSibling,oldn[fluid.position.BEFORE]=element.previousSibling,fluid.dom.moveDom(sourceelements[sourcei],targetelements[targeti],position);var i,frontlimit=samespan?targeti-1:sourceelements.length-2;if(position===fluid.position.BEFORE&&samespan&&frontlimit--,!samespan||targeti>sourcei){for(i=frontlimit;i>sourcei;--i)fluid.dom.moveDom(sourceelements[i+1],sourceelements[i],fluid.position.AFTER);sourcei+1<sourceelements.length&&fluid.dom.moveDom(sourceelements[sourcei+1],oldn[fluid.position.AFTER],fluid.position.BEFORE)}var backlimit=samespan?sourcei-1:targetelements.length-1;if(position===fluid.position.AFTER&&targeti++,!samespan||sourcei>targeti){for(i=targeti;backlimit>i;++i)fluid.dom.moveDom(targetelements[i],targetelements[i+1],fluid.position.BEFORE);backlimit>=0&&backlimit<targetelements.length-1&&fluid.dom.moveDom(targetelements[backlimit],oldn[fluid.position.BEFORE],fluid.position.AFTER)}};var curCss=function(a,name){return window.getComputedStyle?window.getComputedStyle(a,null).getPropertyValue(name):a.currentStyle[name]};fluid.dom.isAttached=function(node){for(;node&&node.nodeName;){if("BODY"===node.nodeName)return!0;node=node.parentNode}return!1},fluid.dom.generalHidden=function(a){return"hidden"===a.type||"none"===curCss(a,"display")||"hidden"===curCss(a,"visibility")||!fluid.dom.isAttached(a)},fluid.registerNamespace("fluid.geometricManager"),fluid.geometricManager.computeGeometry=function(element,orientation,disposition){var elem={};elem.element=element,elem.orientation=orientation,disposition===fluid.position.INSIDE&&(elem.position=disposition),fluid.dom.generalHidden(element)&&(elem.clazz="hidden");var pos=fluid.dom.computeAbsolutePosition(element)||[0,0],width=element.offsetWidth,height=element.offsetHeight;return elem.rect={left:pos[0],top:pos[1]},elem.rect.right=pos[0]+width,elem.rect.bottom=pos[1]+height,elem};var SENTINEL_DIMENSION=1e4;fluid.geometricManager.dumprect=function(rect){return"Rect top: "+rect.top+" left: "+rect.left+" bottom: "+rect.bottom+" right: "+rect.right},fluid.geometricManager.dumpelem=function(cacheelem){return cacheelem&&cacheelem.rect?fluid.geometricManager.dumprect(cacheelem.rect)+" position: "+cacheelem.position+" for "+fluid.dumpEl(cacheelem.element):"null"},fluid.dropManager=function(){var lastClosest,lastGeometry,displacementX,displacementY,targets=[],cache={},that={};that.updateGeometry=function(geometricInfo){lastGeometry=geometricInfo,targets=[],cache={};for(var mapper=geometricInfo.elementMapper,geometryComputor=geometricInfo.geometryComputor||fluid.geometricManager.computeGeometry,processElement=function(element,extent,sentB,sentF,disposition,index){var orientation=extent.orientation,sides=fluid.rectSides[orientation],cacheelem=geometryComputor(element,orientation,disposition);cacheelem.owner=extent,"hidden"!==cacheelem.clazz&&mapper&&(cacheelem.clazz=mapper(element)),cache[fluid.dropManager.cacheKey(element)]=cacheelem;var backClass=fluid.dropManager.getRelativeClass(extent.elements,index,fluid.position.BEFORE,cacheelem.clazz,mapper),frontClass=fluid.dropManager.getRelativeClass(extent.elements,index,fluid.position.AFTER,cacheelem.clazz,mapper);return disposition===fluid.position.INSIDE?targets[targets.length]=cacheelem:fluid.dropManager.splitElement(targets,sides,cacheelem,disposition,backClass,frontClass),sentB&&geometricInfo.sentinelize&&fluid.dropManager.sentinelizeElement(targets,sides,cacheelem,1,disposition,backClass),sentF&&geometricInfo.sentinelize&&fluid.dropManager.sentinelizeElement(targets,sides,cacheelem,0,disposition,frontClass),cacheelem},i=0;i<geometricInfo.extents.length;++i){for(var thisInfo=geometricInfo.extents[i],allHidden=!0,j=0;j<thisInfo.elements.length;++j){var element=thisInfo.elements[j],cacheelem=processElement(element,thisInfo,0===j,j===thisInfo.elements.length-1,fluid.position.INTERLEAVED,j);"hidden"!==cacheelem.clazz&&(allHidden=!1)}allHidden&&thisInfo.parentElement&&processElement(thisInfo.parentElement,thisInfo,!0,!0,fluid.position.INSIDE)}fluid.dropManager.normalizeSentinels(targets)},that.startDrag=function(event,handlePos,handleWidth,handleHeight){var handleMidX=handlePos[0]+handleWidth/2,handleMidY=handlePos[1]+handleHeight/2,dX=handleMidX-event.pageX,dY=handleMidY-event.pageY;that.updateGeometry(lastGeometry),lastClosest=null,displacementX=dX,displacementY=dY,$("body").bind("mousemove.fluid-dropManager",that.mouseMove)},that.lastPosition=function(){return lastClosest},that.endDrag=function(){$("body").unbind("mousemove.fluid-dropManager")},that.mouseMove=function(evt){var x=evt.pageX+displacementX,y=evt.pageY+displacementY,closestTarget=that.closestTarget(x,y,lastClosest);closestTarget&&closestTarget!==fluid.dropManager.NO_CHANGE&&(lastClosest=closestTarget,that.dropChangeFirer.fire(closestTarget))},that.dropChangeFirer=fluid.event.getEventFirer();var blankHolder={element:null};return that.closestTarget=function(x,y,lastClosest){for(var mindistance=Number.MAX_VALUE,minelem=blankHolder,minlockeddistance=Number.MAX_VALUE,minlockedelem=blankHolder,i=0;i<targets.length;++i){var cacheelem=targets[i];if("hidden"!==cacheelem.clazz){var distance=fluid.geom.minPointRectangle(x,y,cacheelem.rect);if("locked"===cacheelem.clazz)minlockeddistance>distance&&(minlockeddistance=distance,minlockedelem=cacheelem);else if(mindistance>distance&&(mindistance=distance,minelem=cacheelem),0===distance)break}}return minelem?(minlockeddistance>=mindistance&&(minlockedelem=blankHolder),lastClosest&&lastClosest.position===minelem.position&&fluid.unwrap(lastClosest.element)===fluid.unwrap(minelem.element)&&fluid.unwrap(lastClosest.lockedelem)===fluid.unwrap(minlockedelem.element)?fluid.dropManager.NO_CHANGE:{position:minelem.position,element:minelem.element,lockedelem:minlockedelem.element}):minelem},that.shuffleProjectFrom=function(element,direction,includeLocked,disableWrap){var togo=that.projectFrom(element,direction,includeLocked,disableWrap);return togo&&(togo.position=fluid.position.REPLACE),togo},that.projectFrom=function(element,direction,includeLocked,disableWrap){that.updateGeometry(lastGeometry);var cacheelem=cache[fluid.dropManager.cacheKey(element)],projected=fluid.geom.projectFrom(cacheelem.rect,direction,targets,includeLocked,disableWrap);if(!projected.cacheelem)return null;var retpos=projected.cacheelem.position;return{element:projected.cacheelem.element,position:retpos?retpos:fluid.position.BEFORE}},that.logicalFrom=function(element,direction,includeLocked,disableWrap){var orderables=that.getOwningSpan(element,fluid.position.INTERLEAVED,includeLocked);return{element:fluid.dropManager.getRelativeElement(element,direction,orderables,disableWrap),position:fluid.position.REPLACE}},that.lockedWrapFrom=function(element,direction,includeLocked,disableWrap){var base=that.logicalFrom(element,direction,includeLocked,disableWrap),selectables=that.getOwningSpan(element,fluid.position.INTERLEAVED,includeLocked),allElements=cache[fluid.dropManager.cacheKey(element)].owner.elements;if(includeLocked||selectables[0]===allElements[0])return base;var directElement=fluid.dropManager.getRelativeElement(element,direction,allElements,disableWrap);return"locked"===lastGeometry.elementMapper(directElement)&&(base.element=null,base.clazz="locked"),base},that.getOwningSpan=function(element,position,includeLocked){var owner=cache[fluid.dropManager.cacheKey(element)].owner,elements=position===fluid.position.INSIDE?[owner.parentElement]:owner.elements;return!includeLocked&&lastGeometry.elementMapper&&(elements=fluid.makeArray(elements),fluid.remove_if(elements,function(element){return"locked"===lastGeometry.elementMapper(element)})),elements},that.geometricMove=function(element,target,position){var sourceElements=that.getOwningSpan(element,null,!0),targetElements=that.getOwningSpan(target,position,!0);fluid.dom.permuteDom(element,target,position,sourceElements,targetElements)},that},fluid.dropManager.NO_CHANGE="no change",fluid.dropManager.cacheKey=function(element){return fluid.allocateSimpleId(element)},fluid.dropManager.sentinelizeElement=function(targets,sides,cacheelem,fc,disposition,clazz){var elemCopy=$.extend(!0,{},cacheelem);elemCopy.origRect=fluid.copy(elemCopy.rect),elemCopy.rect[sides[fc]]=elemCopy.rect[sides[1-fc]]+(fc?1:-1),elemCopy.rect[sides[1-fc]]=(fc?-1:1)*SENTINEL_DIMENSION,elemCopy.position=disposition===fluid.position.INSIDE?disposition:fc?fluid.position.BEFORE:fluid.position.AFTER,elemCopy.clazz=clazz,targets[targets.length]=elemCopy},fluid.dropManager.normalizeSentinels=function(targets){for(var i=0;i<targets.length;++i)for(var j=0;j<targets.length;++j){var ti=targets[i],tj=targets[j],jrect=tj.origRect||tj.rect;ti.element!==tj.element&&ti.origRect&&0===fluid.geom.minRectRect(ti.rect,jrect)&&(ti.rect=ti.origRect,delete ti.origRect)}},fluid.dropManager.splitElement=function(targets,sides,cacheelem,disposition,clazz1,clazz2){var elem1=$.extend(!0,{},cacheelem),elem2=$.extend(!0,{},cacheelem),midpoint=(elem1.rect[sides[0]]+elem1.rect[sides[1]])/2;elem1.rect[sides[1]]=midpoint,elem1.position=fluid.position.BEFORE,elem2.rect[sides[0]]=midpoint,elem2.position=fluid.position.AFTER,elem1.clazz=clazz1,elem2.clazz=clazz2,targets[targets.length]=elem1,targets[targets.length]=elem2},fluid.dropManager.getRelativeClass=function(thisElements,index,relative,thisclazz,mapper){return index+=relative,0>index&&"locked"===thisclazz?"locked":index>=thisElements.length||null===mapper?null:(relative=thisElements[index],"locked"===mapper(relative)&&"locked"===thisclazz?"locked":null)},fluid.dropManager.getRelativeElement=function(element,direction,elements,disableWrap){var folded=fluid.directionSign(direction),index=$(elements).index(element)+folded;return 0>index&&(index+=elements.length),!disableWrap||index!==elements.length&&index!==elements.length+folded?(index%=elements.length,elements[index]):element},fluid.geom=fluid.geom||{},fluid.geom.minPointRectangle=function(x,y,rectangle){var dx=x<rectangle.left?rectangle.left-x:x>rectangle.right?x-rectangle.right:0,dy=y<rectangle.top?rectangle.top-y:y>rectangle.bottom?y-rectangle.bottom:0;return dx*dx+dy*dy},fluid.geom.minRectRect=function(rect1,rect2){var dx=rect1.right<rect2.left?rect2.left-rect1.right:rect2.right<rect1.left?rect1.left-rect2.right:0,dy=rect1.bottom<rect2.top?rect2.top-rect1.bottom:rect2.bottom<rect1.top?rect1.top-rect2.bottom:0;return dx*dx+dy*dy};var makePenCollect=function(){return{mindist:Number.MAX_VALUE,minrdist:Number.MAX_VALUE}};fluid.geom.projectFrom=function(baserect,direction,targets,forSelection,disableWrap){function accPen(collect,cacheelem,backSign){var thisrect=cacheelem.rect,pdist=fluid.geom.minRectRect(penrect,thisrect),rdist=-dirSign*backSign*(baserect[1===backSign?frontSide:backSide]-thisrect[1===backSign?backSide:frontSide]);if(pdist<=collect.mindist&&rdist>=0){if(pdist===collect.mindist&&rdist*backSign>collect.minrdist)return;collect.minrdist=rdist*backSign,collect.mindist=pdist,collect.minelem=cacheelem}}var axis=fluid.directionAxis(direction),frontSide=fluid.rectSides[direction],backSide=fluid.rectSides[15*axis+5-direction],dirSign=fluid.directionSign(direction),penrect={left:(7*baserect.left+1*baserect.right)/8,right:(5*baserect.left+3*baserect.right)/8,top:(7*baserect.top+1*baserect.bottom)/8,bottom:(5*baserect.top+3*baserect.bottom)/8};penrect[frontSide]=dirSign*SENTINEL_DIMENSION,penrect[backSide]=-penrect[frontSide];for(var collect=makePenCollect(),backcollect=makePenCollect(),lockedcollect=makePenCollect(),i=0;i<targets.length;++i){var elem=targets[i],isPure=elem.owner&&elem.element===elem.owner.parentElement;"hidden"===elem.clazz||forSelection&&isPure||(forSelection||"locked"!==elem.clazz?(accPen(collect,elem,1),accPen(backcollect,elem,-1)):accPen(lockedcollect,elem,1))}var wrap=!collect.minelem||backcollect.mindist<collect.mindist;wrap=wrap&&!disableWrap;var mincollect=wrap?backcollect:collect,togo={wrapped:wrap,cacheelem:mincollect.minelem};return lockedcollect.mindist<mincollect.mindist&&(togo.lockedelem=lockedcollect.minelem),togo}}(jQuery,fluid_1_5);