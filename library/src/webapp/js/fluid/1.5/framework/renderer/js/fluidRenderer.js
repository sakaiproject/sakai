fluid_1_5=fluid_1_5||{},function($,fluid){"use strict";function debugPosition(component){return"as child of "+(component.parent.fullID?"component with full ID "+component.parent.fullID:"root")}function computeFullID(component){var togo="",move=component;for(void 0===component.children&&(togo=component.ID+(void 0!==component.localID?component.localID:""),move=component.parent);move.parent;){var parent=move.parent;if(void 0!==move.fullID)return togo=move.fullID+togo;if(void 0===move.noID){var ID=move.ID;void 0===ID&&fluid.fail("Error in component tree - component found with no ID "+debugPosition(parent)+": please check structure");var colpos=ID.indexOf(":"),prefix=-1===colpos?ID:ID.substring(0,colpos);togo=prefix+":"+(void 0===move.localID?"":move.localID)+":"+togo}move=parent}return togo}function processChild(value,key){if(renderer.isBoundPrimitive(value))return{componentType:"UIBound",value:value,ID:key};var unzip=unzipComponent(value);return unzip.ID?{ID:key,componentType:"UIContainer",children:[unzip]}:(unzip.ID=key,unzip)}function fixChildren(children){if(fluid.isArrayable(children))return children;var togo=[];for(var key in children){var value=children[key];if(fluid.isArrayable(value))for(var i=0;i<value.length;++i){var processed=processChild(value[i],key);togo[togo.length]=processed}else togo[togo.length]=processChild(value,key)}return togo}function fixupValue(uibound,model,resolverGetConfig){void 0===uibound.value&&void 0!==uibound.valuebinding&&(model||fluid.fail("Cannot perform value fixup for valuebinding "+uibound.valuebinding+" since no model was supplied to rendering"),uibound.value=fluid.get(model,uibound.valuebinding,resolverGetConfig))}function upgradeBound(holder,property,model,resolverGetConfig){void 0!==holder[property]?renderer.isBoundPrimitive(holder[property])?holder[property]={value:holder[property]}:holder[property].messagekey&&(holder[property].componentType="UIMessage"):holder[property]={value:null},fixupValue(holder[property],model,resolverGetConfig)}function fixupTree(tree,model,resolverGetConfig){if(void 0===tree.componentType&&(tree=unzipComponent(tree,model,resolverGetConfig)),"UIContainer"===tree.componentType||tree.parent||(tree={children:[tree]}),tree.children){tree.childmap={};for(var i=0;i<tree.children.length;++i){var child=tree.children[i];void 0===child.componentType&&(child=unzipComponent(child,model,resolverGetConfig),tree.children[i]=child),child.parent=tree,void 0===child.ID&&fluid.fail("Error in component tree: component found with no ID "+debugPosition(child)),tree.childmap[child.ID]=child;var colpos=child.ID.indexOf(":");if(-1===colpos);else{var prefix=child.ID.substring(0,colpos),childlist=tree.childmap[prefix];childlist||(childlist=[],tree.childmap[prefix]=childlist),void 0===child.localID&&0!==childlist.length&&(child.localID=childlist.length),childlist[childlist.length]=child}child.fullID=computeFullID(child);var componentType=child.componentType;if("UISelect"===componentType)child.selection.fullID=child.fullID;else if("UIInitBlock"===componentType){for(var call=child.functionname+"(",childArgs=child.arguments,j=0;j<childArgs.length;++j)childArgs[j]instanceof fluid.ComponentReference&&(childArgs[j]=child.parent.fullID+childArgs[j].reference),call+=JSON.stringify(childArgs[j]),j<childArgs.length-1&&(call+=", ");child.markup={value:call+")\n"},child.componentType="UIVerbatim"}else"UIBound"===componentType&&fixupValue(child,model,resolverGetConfig);fixupTree(child,model,resolverGetConfig)}}return tree}function findNodeValue(rootNode){var node=fluid.dom.iterateDom(rootNode,function(node){return 8===node.nodeType||4===node.nodeType?"stop":null},!0),value=node.nodeValue;return 0===value.indexOf("[CDATA[")?value.substring(6,value.length-2):value}var renderer={};renderer.isBoundPrimitive=function(value){return fluid.isPrimitive(value)||fluid.isArrayable(value)&&(0===value.length||"string"==typeof value[0])};var unzipComponent;renderer.duckMap={children:"UIContainer",value:"UIBound",valuebinding:"UIBound",messagekey:"UIMessage",markup:"UIVerbatim",selection:"UISelect",target:"UILink",choiceindex:"UISelectChoice",functionname:"UIInitBlock"};var boundMap={UISelect:["selection","optionlist","optionnames"],UILink:["target","linktext"],UIVerbatim:["markup"],UIMessage:["messagekey"]};renderer.boundMap=fluid.transform(boundMap,fluid.arrayToHash),renderer.inferComponentType=function(component){for(var key in renderer.duckMap)if(void 0!==component[key])return renderer.duckMap[key]},renderer.applyComponentType=function(component){component.componentType=renderer.inferComponentType(component),void 0===component.componentType&&void 0!==component.ID&&(component.componentType="UIBound")},unzipComponent=function(component,model,resolverGetConfig){if(component&&renderer.applyComponentType(component),!component||void 0===component.componentType){var decorators=component.decorators;decorators&&delete component.decorators,component={componentType:"UIContainer",children:component},component.decorators=decorators}var cType=component.componentType;if("UIContainer"===cType)component.children=fixChildren(component.children);else{var map=renderer.boundMap[cType];map&&fluid.each(map,function(value,key){upgradeBound(component,key,model,resolverGetConfig)})}return component},fluid.NULL_STRING="▩null▩";var LINK_ATTRIBUTES={a:"href",link:"href",img:"src",frame:"src",script:"src",style:"src",input:"src",embed:"src",form:"action",applet:"codebase",object:"codebase"};renderer.decoratorComponentPrefix="**-renderer-",renderer.IDtoComponentName=function(ID,num){return renderer.decoratorComponentPrefix+ID.replace(/\./g,"")+"-"+num},renderer.invokeFluidDecorator=function(func,args,ID,num,options){var that;if(options.parentComponent){var parent=options.parentComponent,name=renderer.IDtoComponentName(ID,num);fluid.set(parent,fluid.path("options","components",name),{type:func}),that=fluid.initDependent(options.parentComponent,name,args)}else that=fluid.invokeGlobalFunction(func,args);return that},fluid.renderer=function(templates,tree,options,fossilsIn){function getRewriteKey(template,parent,id){return template.resourceKey+parent.fullID+id}function resolveInScope(searchID,defprefix,scope){var deflump,scopelook=scope?scope[searchID]:null;if(scopelook)for(var i=0;i<scopelook.length;++i){var scopelump=scopelook[i];if(deflump||scopelump.rsfID!==defprefix||(deflump=scopelump),scopelump.rsfID===searchID)return scopelump}return deflump}function resolveCall(sourcescope,child){var searchID=child.jointID?child.jointID:child.ID,split=fluid.SplitID(searchID),defprefix=split.prefix+":",match=resolveInScope(searchID,defprefix,sourcescope.downmap,child);return match?match:child.children&&(match=resolveInScope(searchID,defprefix,globalmap,child))?match:null}function noteCollected(template){seenset[template.href]||(fluid.aggregateMMap(collected,template.collectmap),seenset[template.href]=!0)}function resolveRecurse(basecontainer,parentlump){var i,id,resolved;for(i=0;i<basecontainer.children.length;++i){var branch=basecontainer.children[i];branch.children&&(resolved=resolveCall(parentlump,branch),resolved&&(branchmap[branch.fullID]=resolved,id=resolved.attributemap.id,void 0!==id&&(rewritemap[getRewriteKey(parentlump.parent,basecontainer,id)]=branch.fullID),noteCollected(resolved.parent),resolveRecurse(branch,resolved)))}if(parentlump.downmap)for(id in parentlump.downmap){var lumps=parentlump.downmap[id];for(i=0;i<lumps.length;++i){var lump=lumps[i],lumpid=lump.attributemap.id;if(void 0!==lumpid&&void 0!==lump.rsfID&&(resolved=fetchComponent(basecontainer,lump.rsfID),null!==resolved)){var resolveID=resolved.fullID;rewritemap[getRewriteKey(parentlump.parent,basecontainer,lumpid)]=resolveID}}}}function resolveBranches(globalmapp,basecontainer,parentlump){branchmap={},rewritemap={},seenset={},collected={},globalmap=globalmapp,branchmap[basecontainer.fullID]=parentlump,resolveRecurse(basecontainer,parentlump)}function dumpTillLump(lumps,start,limit){for(;limit>start;++start){var text=lumps[start].text;text&&(out+=lumps[start].text)}}function dumpScan(lumps,renderindex,basedepth,closeparent,insideleaf){for(var start=renderindex;;){if(renderindex===lumps.length)break;var lump=lumps[renderindex];if(lump.nestingdepth<basedepth)break;if(void 0!==lump.rsfID){if(!insideleaf)break;if(!(insideleaf&&lump.nestingdepth>basedepth+(closeparent?0:1)))break;fluid.log("Error in component tree - leaf component found to contain further components - at "+lump.toString())}++renderindex}return closeparent||renderindex!==lumps.length&&lumps[renderindex].rsfID||--renderindex,dumpTillLump(lumps,start,renderindex),renderindex}function isPlaceholder(){return!1}function isValue(value){return null!==value&&void 0!==value&&!isPlaceholder(value)}function openTag(){trc.iselide||(out+="<"+trc.uselump.tagname)}function closeTag(){trc.iselide||(out+="</"+trc.uselump.tagname+">")}function renderUnchanged(){dumpTillLump(trc.uselump.parent.lumps,trc.uselump.lumpindex+1,trc.close.lumpindex+(trc.iselide?0:1))}function isSelfClose(){return trc.endopen.lumpindex===trc.close.lumpindex&&fluid.XMLP.closedTags[trc.uselump.tagname]}function dumpTemplateBody(){isSelfClose()?trc.iselide||(out+="/>"):(trc.iselide||(out+=">"),dumpTillLump(trc.uselump.parent.lumps,trc.endopen.lumpindex,trc.close.lumpindex+(trc.iselide?0:1)))}function replaceAttributes(){trc.iselide||(out+=fluid.dumpAttributes(trc.attrcopy)),dumpTemplateBody()}function replaceAttributesOpen(){if(trc.iselide)replaceAttributes();else{out+=fluid.dumpAttributes(trc.attrcopy);var selfClose=isSelfClose();out+=selfClose?"/>":">",trc.nextpos=selfClose?trc.close.lumpindex+1:trc.endopen.lumpindex}}function replaceBody(value){out+=fluid.dumpAttributes(trc.attrcopy),trc.iselide||(out+=">"),out+=fluid.XMLEncode(value.toString()),closeTag()}function rewriteLeaf(value){isValue(value)?replaceBody(value):replaceAttributes()}function rewriteLeafOpen(value){trc.iselide?rewriteLeaf(trc.value):isValue(value)?replaceBody(value):replaceAttributesOpen()}function rewriteUrl(template,url){if(renderOptions.urlRewriter){var rewritten=renderOptions.urlRewriter(url);if(rewritten)return rewritten}if(!renderOptions.rebaseURLs)return url;var protpos=url.indexOf(":/");return"/"===url.charAt(0)||-1!==protpos&&7>protpos?url:renderOptions.baseURL+url}function dumpHiddenField(todump){out+='<input type="hidden" ';var isvirtual=todump.virtual,outattrs={};outattrs[isvirtual?"id":"name"]=todump.name,outattrs.value=todump.value,out+=fluid.dumpAttributes(outattrs),out+=" />\n"}function applyAutoBind(torender,finalID){function applyFunc(){fluid.applyBoundChange(fluid.byId(finalID,renderOptions.document),void 0,applier)}if(finalID){var tagname=trc.uselump.tagname,applier=renderOptions.applier;if(renderOptions.autoBind&&/input|select|textarea/.test(tagname)&&!renderedbindings[finalID]){var decorators=[{jQuery:["change",applyFunc]}];$.browser.msie&&"input"===tagname&&/radio|checkbox/.test(trc.attrcopy.type)&&decorators.push({jQuery:["click",applyFunc]}),$.browser.safari&&"input"===tagname&&"radio"===trc.attrcopy.type&&decorators.push({jQuery:["keyup",applyFunc]}),outDecoratorsImpl(torender,decorators,trc.attrcopy,finalID)}}}function dumpBoundFields(torender,parent){if(torender){var holder=parent?parent:torender;if(renderOptions.fossils&&holder.valuebinding){var fossilKey=holder.submittingname||torender.finalID;renderOptions.fossils[fossilKey]={name:fossilKey,EL:holder.valuebinding,oldvalue:holder.value},applyAutoBind(torender,torender.finalID)}torender.fossilizedbinding&&dumpHiddenField(torender.fossilizedbinding),torender.fossilizedshaper&&dumpHiddenField(torender.fossilizedshaper)}}function dumpSelectionBindings(uiselect){renderedbindings[uiselect.selection.fullID]||(renderedbindings[uiselect.selection.fullID]=!0,dumpBoundFields(uiselect.selection),dumpBoundFields(uiselect.optionlist),dumpBoundFields(uiselect.optionnames))}function isSelectedValue(torender,value){var selection=torender.selection;return selection.value&&"string"!=typeof selection.value&&"number"==typeof selection.value.length?-1!==$.inArray(value,selection.value):selection.value===value}function getRelativeComponent(component,relativeID){for(component=component.parent;0===relativeID.indexOf("..::");)relativeID=relativeID.substring(4),component=component.parent;return component.childmap[relativeID]}function rewriteRewriteMap(from,to){fluid.each(rewritemap,function(value,key){value===from&&(rewritemap[key]=to)})}function adjustForID(attrcopy,component,late,forceID){late||delete attrcopy["rsf:id"],void 0!==component.finalID?attrcopy.id=component.finalID:void 0!==forceID?attrcopy.id=forceID:(attrcopy.id||late)&&(attrcopy.id=component.fullID);for(var count=1,baseid=attrcopy.id;renderOptions.document.getElementById(attrcopy.id)||usedIDs[attrcopy.id];)attrcopy.id=baseid+"-"+count++;return 1!==count&&rewriteRewriteMap(baseid,attrcopy.id),component.finalID=attrcopy.id,attrcopy.id}function assignSubmittingName(attrcopy,component,parent){var submitting=parent||component;return adjustForID(attrcopy,component,!0,component.fullID),void 0===submitting.submittingname&&submitting.willinput!==!1&&(submitting.submittingname=submitting.finalID||submitting.fullID),submitting.submittingname}function explodeDecorators(decorators){var togo=[];if(decorators.type)togo[0]=decorators;else for(var key in decorators){"$"===key&&(key="jQuery");var value=decorators[key],decorator={type:key};"jQuery"===key?(decorator.func=value[0],decorator.args=value.slice(1)):"addClass"===key||"removeClass"===key?decorator.classes=value:"attrs"===key?decorator.attributes=value:"identify"===key&&(decorator.key=value),togo[togo.length]=decorator}return togo}function outDecorators(torender,attrcopy){torender.decorators&&(void 0===torender.decorators.length&&(torender.decorators=explodeDecorators(torender.decorators)),outDecoratorsImpl(torender,torender.decorators,attrcopy))}function dumpBranchHead(branch,targetlump){if(!targetlump.elide){var attrcopy={};$.extend(!0,attrcopy,targetlump.attributemap),adjustForID(attrcopy,branch),outDecorators(branch,attrcopy),out+="<"+targetlump.tagname+" ",out+=fluid.dumpAttributes(attrcopy),out+=">"}}function resolveArgs(args){return args?(args=fluid.copy(args),fluid.transform(args,function(arg,index){return upgradeBound(args,index,renderOptions.model,renderOptions.resolverGetConfig),args[index].value})):args}function degradeMessage(torender){if("UIMessage"===torender.componentType)if(torender.componentType="UIBound",renderOptions.messageLocator){upgradeBound(torender,"messagekey",renderOptions.model,renderOptions.resolverGetConfig);var resArgs=resolveArgs(torender.args);torender.value=renderOptions.messageLocator(torender.messagekey.value,resArgs)}else torender.value="[No messageLocator is configured in options - please consult documentation on options.messageSource]"}function renderComponent(torender){function makeFail(torender,end){fluid.fail("Error in component tree - UISelectChoice with id "+torender.fullID+end)}var value,attrcopy=trc.attrcopy;degradeMessage(torender);var componentType=torender.componentType,tagname=trc.uselump.tagname;if(outDecorators(torender,attrcopy),"UIBound"===componentType||"UISelectChoice"===componentType){var parent;void 0!==torender.choiceindex&&(void 0!==torender.parentRelativeID?(parent=getRelativeComponent(torender,torender.parentRelativeID),parent||makeFail(torender," has parentRelativeID of "+torender.parentRelativeID+" which cannot be resolved")):makeFail(torender," does not have parentRelativeID set"),assignSubmittingName(attrcopy,torender,parent.selection),dumpSelectionBindings(parent));var submittingname=parent?parent.selection.submittingname:torender.submittingname;if(!parent&&torender.valuebinding&&(submittingname=assignSubmittingName(attrcopy,torender)),("input"===tagname||"textarea"===tagname)&&void 0!==submittingname&&(attrcopy.name=submittingname),dumpBoundFields(torender,parent?parent.selection:null),"boolean"==typeof torender.value||"radio"===attrcopy.type||"checkbox"===attrcopy.type){var underlyingValue,directValue=torender.value;void 0!==torender.choiceindex&&(parent.optionlist.value||fluid.fail("Error in component tree - selection control with full ID "+parent.fullID+" has no values"),underlyingValue=parent.optionlist.value[torender.choiceindex],directValue=isSelectedValue(parent,underlyingValue)),isValue(directValue)&&(directValue?attrcopy.checked="checked":delete attrcopy.checked),attrcopy.value=fluid.XMLEncode(underlyingValue?underlyingValue:"true"),rewriteLeaf(null)}else fluid.isArrayable(torender.value)?renderUnchanged():(value=parent?parent["textarea"===tagname||"input"===tagname?"optionlist":"optionnames"].value[torender.choiceindex]:torender.value,"textarea"===tagname?(isPlaceholder(value)&&torender.willinput&&(value=""),rewriteLeaf(value)):"input"===tagname?((torender.willinput||isValue(value))&&(attrcopy.value=fluid.XMLEncode(String(value))),rewriteLeaf(null)):(delete attrcopy.name,rewriteLeafOpen(value)))}else if("UISelect"===componentType){var ishtmlselect="select"===tagname,ismultiple=!1;if(fluid.isArrayable(torender.selection.value)&&(ismultiple=!0,ishtmlselect&&(attrcopy.multiple="multiple")),assignSubmittingName(attrcopy,torender.selection),ishtmlselect&&(torender.selection.willinput!==!1&&(attrcopy.name=torender.selection.submittingname),applyAutoBind(torender,attrcopy.id)),out+=fluid.dumpAttributes(attrcopy),ishtmlselect){out+=">";var values=torender.optionlist.value,names=null!==torender.optionnames&&void 0!==torender.optionnames&&torender.optionnames.value?torender.optionnames.value:values;names&&names.length||fluid.fail("Error in component tree - UISelect component with fullID "+torender.fullID+" does not have optionnames set");for(var i=0;i<names.length;++i)out+='<option value="',value=values[i],null===value&&(value=fluid.NULL_STRING),out+=fluid.XMLEncode(value),isSelectedValue(torender,value)&&(out+='" selected="selected'),out+='">',out+=fluid.XMLEncode(names[i]),out+="</option>\n";closeTag()}else dumpTemplateBody();dumpSelectionBindings(torender)}else if("UILink"===componentType){var attrname=LINK_ATTRIBUTES[tagname];if(attrname){degradeMessage(torender.target);var target=torender.target.value;isValue(target)||(target=attrcopy[attrname]),target=rewriteUrl(trc.uselump.parent,target),attrcopy[attrname]=fluid.XMLEncode(target)}value=void 0,torender.linktext&&(degradeMessage(torender.linktext),value=torender.linktext.value),isValue(value)?rewriteLeaf(value):replaceAttributesOpen()}else if(void 0!==torender.markup){degradeMessage(torender.markup);var rendered=torender.markup.value;null===rendered?(out+=fluid.dumpAttributes(attrcopy),out+=">",renderUnchanged()):(trc.iselide||(out+=fluid.dumpAttributes(attrcopy),out+=">"),out+=rendered,closeTag())}void 0!==attrcopy.id&&(usedIDs[attrcopy.id]=!0)}function rewriteIDRelation(context){var attrname,attrval=trc.attrcopy["for"];if(void 0!==attrval?attrname="for":(attrval=trc.attrcopy.headers,void 0!==attrval&&(attrname="headers")),attrname){var tagname=trc.uselump.tagname;if(!("for"===attrname&&"label"!==tagname||"headers"===attrname&&"td"!==tagname&&"th"!==tagname)){var rewritten=rewritemap[getRewriteKey(trc.uselump.parent,context,attrval)];void 0!==rewritten&&(trc.attrcopy[attrname]=rewritten)}}}function renderComment(message){out+="<!-- "+fluid.XMLEncode(message)+"-->"}function renderDebugMessage(message){out+='<span style="background-color:#FF466B;color:white;padding:1px;">',out+=message,out+="</span><br/>"}function reportPath(branch){var path=branch.fullID;return path?"full path "+path:"component tree root"}function renderComponentSystem(context,torendero,lump){var lumpindex=lump.lumpindex,lumps=lump.parent.lumps,nextpos=-1,outerendopen=lumps[lumpindex+1],outerclose=lump.close_tag;nextpos=outerclose.lumpindex+1;var payloadlist=lump.downmap?lump.downmap["payload-component"]:null,payload=payloadlist?payloadlist[0]:null,iselide=126===lump.rsfID.charCodeAt(0),endopen=outerendopen,close=outerclose,uselump=lump,attrcopy={};if($.extend(!0,attrcopy,(null===payload?lump:payload).attributemap),trc.attrcopy=attrcopy,trc.uselump=uselump,trc.endopen=endopen,trc.close=close,trc.nextpos=nextpos,trc.iselide=iselide,rewriteIDRelation(context),null===torendero&&lump.rsfID.indexOf("scr=")===(iselide?1:0)){var scrname=lump.rsfID.substring(4+(iselide?1:0));"ignore"===scrname?nextpos=trc.close.lumpindex+1:"rewrite-url"===scrname?torendero={componentType:"UILink",target:{}}:(openTag(),replaceAttributesOpen(),nextpos=trc.endopen.lumpindex)}return null!==torendero&&(payload&&(trc.endopen=lumps[payload.lumpindex+1],trc.close=payload.close_tag,trc.uselump=payload,dumpTillLump(lumps,lumpindex,payload.lumpindex),lumpindex=payload.lumpindex),adjustForID(attrcopy,torendero),openTag(),renderComponent(torendero),null!==payload&&trc.nextpos===nextpos&&dumpTillLump(lumps,trc.close.lumpindex+1,outerclose.lumpindex+1),nextpos=trc.nextpos),nextpos}function renderContainer(child,targetlump){var t2=targetlump.parent,firstchild=t2.lumps[targetlump.lumpindex+1];void 0!==child.children?dumpBranchHead(child,targetlump):renderComponentSystem(child.parent,child,targetlump),renderRecurse(child,targetlump,firstchild)}function fetchComponents(basecontainer,id){for(var togo;basecontainer&&!(togo=basecontainer.childmap[id]);)basecontainer=basecontainer.parent;return togo}function findChild(sourcescope,child){var split=fluid.SplitID(child.ID),headlumps=sourcescope.downmap[child.ID];return headlumps||(headlumps=sourcescope.downmap[split.prefix+":"]),headlumps?headlumps[0]:null}function renderCollect(collump){dumpTillLump(collump.parent.lumps,collump.lumpindex,collump.close_tag.lumpindex+1)}function renderCollects(){for(var key in collected)for(var collist=collected[key],i=0;i<collist.length;++i)renderCollect(collist[i])}function processDecoratorQueue(){for(var i=0;i<decoratorQueue.length;++i)for(var decorator=decoratorQueue[i],j=0;j<decorator.ids.length;++j){var id=decorator.ids[j],node=fluid.byId(id,renderOptions.document);if(node||fluid.fail("Error during rendering - component with id "+id+" which has a queued decorator was not found in the output markup"),"jQuery"===decorator.type){var jnode=renderOptions.jQuery(node);jnode[decorator.func].apply(jnode,fluid.makeArray(decorator.args))}else if("fluid"===decorator.type){var args=decorator.args;if(!args){var thisContainer=renderOptions.jQuery(node);decorator.container?decorator.container.push(node):decorator.container=thisContainer,args=[thisContainer,decorator.options]}var that=renderer.invokeFluidDecorator(decorator.func,args,id,i,options);decorator.that=that}else"event"===decorator.type&&(node[decorator.event]=decorator.handler)}}options=options||{},tree=tree||{};var debugMode=options.debugMode;!options.messageLocator&&options.messageSource&&(options.messageLocator=fluid.resolveMessageSource(options.messageSource)),options.document=options.document||document,options.jQuery=options.jQuery||$,options.fossils=options.fossils||fossilsIn||{};var fetchComponent,outDecoratorsImpl,globalmap={},branchmap={},rewritemap={},seenset={},collected={},out="",renderOptions=options,decoratorQueue=[],renderedbindings={},usedIDs={},that={options:options},trc={};outDecoratorsImpl=function(torender,decorators,attrcopy,finalID){var id,sanitizeAttrs=function(value,key){null===value||void 0===value?delete attrcopy[key]:attrcopy[key]=fluid.XMLEncode(value)};renderOptions.idMap=renderOptions.idMap||{};for(var i=0;i<decorators.length;++i){var decorator=decorators[i],type=decorator.type;if(type)if("$"===type&&(type=decorator.type="jQuery"),"jQuery"===type||"event"===type||"fluid"===type)id=adjustForID(attrcopy,torender,!0,finalID),void 0===decorator.ids&&(decorator.ids=[],decoratorQueue[decoratorQueue.length]=decorator),decorator.ids.push(id);else if("attrs"===type)fluid.each(decorator.attributes,sanitizeAttrs);else if("addClass"===type||"removeClass"===type){var fakeNode={nodeType:1,className:attrcopy["class"]||""};renderOptions.jQuery(fakeNode)[type](decorator.classes),attrcopy["class"]=fakeNode.className}else"identify"===type?(id=adjustForID(attrcopy,torender,!0,finalID),renderOptions.idMap[decorator.key]=id):"null"!==type&&fluid.log("Unrecognised decorator of type "+type+" found at component of ID "+finalID);else{var explodedDecorators=explodeDecorators(decorator);outDecoratorsImpl(torender,explodedDecorators,attrcopy,finalID)}}};var renderRecurse;return fetchComponent=function(basecontainer,id){if(0===id.indexOf("msg=")){var key=id.substring(4);return{componentType:"UIMessage",messagekey:key}}for(;basecontainer;){var togo=basecontainer.childmap[id];if(togo)return togo;basecontainer=basecontainer.parent}return null},renderRecurse=function(basecontainer,parentlump,baselump){var children,targetlump,child,rendered,renderindex=baselump.lumpindex,basedepth=parentlump.nestingdepth,t1=parentlump.parent;for(debugMode&&(rendered={});;){if(renderindex=dumpScan(t1.lumps,renderindex,basedepth,!parentlump.elide,!1),renderindex===t1.lumps.length)break;var lump=t1.lumps[renderindex],id=lump.rsfID;if(lump.nestingdepth<basedepth||void 0===id)break;if(126===id.charCodeAt(0)&&(id=id.substring(1)),-1!==id.indexOf(":")){var prefix=fluid.getPrefix(id);children=fetchComponents(basecontainer,prefix);var finallump=lump.uplump.finallump[prefix],closefinal=finallump.close_tag;if(children)for(var i=0;i<children.length;++i)if(child=children[i],child.children)debugMode&&(rendered[child.fullID]=!0),targetlump=branchmap[child.fullID],targetlump?(debugMode&&renderComment("Branching for "+child.fullID+" from "+fluid.debugLump(lump)+" to "+fluid.debugLump(targetlump)),renderContainer(child,targetlump),debugMode&&renderComment("Branch returned for "+child.fullID+fluid.debugLump(lump)+" to "+fluid.debugLump(targetlump))):debugMode&&renderDebugMessage("No matching template branch found for branch container with full ID "+child.fullID+" rendering from parent template branch "+fluid.debugLump(baselump));else{if(targetlump=findChild(parentlump,child),!targetlump){debugMode&&renderDebugMessage("Repetitive leaf with full ID "+child.fullID+" could not be rendered from parent template branch "+fluid.debugLump(baselump));continue}var renderend=renderComponentSystem(basecontainer,child,targetlump),wasopentag=renderend<t1.lumps.lengtn&&t1.lumps[renderend].nestingdepth>=targetlump.nestingdepth,newbase=child.children?child:basecontainer;wasopentag&&(renderRecurse(newbase,targetlump,t1.lumps[renderend]),renderend=targetlump.close_tag.lumpindex+1),i!==children.length-1?renderend<closefinal.lumpindex&&dumpScan(t1.lumps,renderend,targetlump.nestingdepth-1,!1,!1):dumpScan(t1.lumps,renderend,targetlump.nestingdepth,!0,!1)}else debugMode&&renderDebugMessage("No branch container with prefix "+prefix+": found in container "+reportPath(basecontainer)+" rendering at template position "+fluid.debugLump(baselump)+", skipping");renderindex=closefinal.lumpindex+1,debugMode&&renderComment("Stack returned from branch for ID "+id+" to "+fluid.debugLump(baselump)+": skipping from "+fluid.debugLump(lump)+" to "+fluid.debugLump(closefinal))}else{var component;id&&(component=fetchComponent(basecontainer,id,lump),debugMode&&component&&(rendered[component.fullID]=!0)),component&&void 0!==component.children?(renderContainer(component),renderindex=lump.close_tag.lumpindex+1):renderindex=renderComponentSystem(basecontainer,component,lump)}if(renderindex===t1.lumps.length)break}if(debugMode){children=basecontainer.children;for(var key=0;key<children.length;++key)child=children[key],rendered[child.fullID]||renderDebugMessage("Component "+child.componentType+" with full ID "+child.fullID+" could not be found within template "+fluid.debugLump(baselump))}},that.renderTemplates=function(){tree=fixupTree(tree,options.model,options.resolverGetConfig);var template=templates[0];return resolveBranches(templates.globalmap,tree,template.rootlump),renderedbindings={},renderCollects(),renderRecurse(tree,template.rootlump,template.lumps[template.firstdocumentindex]),out},that.processDecoratorQueue=function(){processDecoratorQueue()},that},jQuery.extend(!0,fluid.renderer,renderer),fluid.ComponentReference=function(reference){this.reference=reference},fluid.explode=function(hash,basepath){var togo=[];for(var key in hash){var binding=void 0===basepath?key:basepath+"."+key;togo[togo.length]={ID:key,value:hash[key],valuebinding:binding}}return togo},fluid.explodeSelectionToInputs=function(optionlist,opts){return fluid.transform(optionlist,function(option,index){return{ID:opts.rowID,children:[{ID:opts.inputID,parentRelativeID:"..::"+opts.selectID,choiceindex:index},{ID:opts.labelID,parentRelativeID:"..::"+opts.selectID,choiceindex:index}]}})},fluid.resolveMessageSource=function(messageSource){if("data"===messageSource.type){if(void 0===messageSource.url)return fluid.messageLocator(messageSource.messages,messageSource.resolveFunc)}else if("resolver"===messageSource.type)return messageSource.resolver.resolve},fluid.renderTemplates=function(templates,tree,options,fossilsIn){var renderer=fluid.renderer(templates,tree,options,fossilsIn),rendered=renderer.renderTemplates();return rendered},fluid.reRender=function(templates,node,tree,options){options=options||{};var renderer=fluid.renderer(templates,tree,options,options.fossils);options=renderer.options,node=fluid.unwrap(node);var lastId,lastFocusedElement=fluid.getLastFocusedElement?fluid.getLastFocusedElement():null;lastFocusedElement&&fluid.dom.isContainer(node,lastFocusedElement)&&(lastId=lastFocusedElement.id),$.browser.msie?options.jQuery(node).empty():node.innerHTML="";var rendered=renderer.renderTemplates();if(options.renderRaw&&(rendered=fluid.XMLEncode(rendered),rendered=rendered.replace(/\n/g,"<br/>")),options.model&&fluid.bindFossils(node,options.model,options.fossils),$.browser.msie?options.jQuery(node).html(rendered):node.innerHTML=rendered,renderer.processDecoratorQueue(),lastId){var element=fluid.byId(lastId,options.document);element&&options.jQuery(element).focus()}return templates},fluid.extractTemplate=function(node,armouring){return armouring?findNodeValue(node):node.innerHTML},fluid.render=function(source,target,tree,options){options=options||{};var template=source;"object"==typeof source&&(template=fluid.extractTemplate(fluid.unwrap(source.node),source.armouring)),target=fluid.unwrap(target);var resourceSpec={base:{resourceText:template,href:".",resourceKey:".",cutpoints:options.cutpoints}},templates=fluid.parseTemplates(resourceSpec,["base"],options);return fluid.reRender(templates,target,tree,options)},fluid.selfRender=function(node,tree,options){return options=options||{},fluid.render({node:node,armouring:options.armouring},node,tree,options)}}(jQuery,fluid_1_5);