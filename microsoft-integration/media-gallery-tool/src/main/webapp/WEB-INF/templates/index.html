<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head th:replace="fragments/common :: head" />

	<body>
		<div th:replace="fragments/common :: bootstrap" />

		<div class="sak-banner-error hidden" id="exception_error"></div>

		<th:block th:fragment="common-body">
			<div id="body-loaded">
				<th:block th:if="${!firstTime}">
					<div th:if="${typesKeys == null or typesKeys.empty}" class="sak-banner-info" th:text="#{no_synchronized}"></div>
					
					<th:block th:if="${typesKeys != null and !typesKeys.empty}">
						<div class="container-view container-fluid collapse" th:classappend="${!treeView}? 'in'">
							<div class="container-header">
								<h2><span th:text="#{tree_view}"/><span role="button" class="icon-toggle fa fa-toggle-off" onclick="toggleView()" th:title="#{tree_view_off}"></span></h2>
								<form th:action="@{/index}">
									<input type="hidden" name="treeView" value="false" />
									<div>
										<label th:text="#{order_by}"></label>
										<select name="sortBy" onchange="sortChanged(this)">
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:text="#{sort_by_name_ascending}" ></option>
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:text="#{sort_by_name_descending}"></option>
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:text="#{sort_by_date_ascending}"></option>
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:text="#{sort_by_date_descending}"></option>
										</select>
									</div>
									<div>
										<input 
											type="search"
											class="input-search"
											onkeyup="doSearch(this)"
											th:placeholder="|&#xF002; #{search}|"
										/>
									</div>
								</form>
							</div>
							<div class="container-fluid">
								<div class="panel-group" id="accordion_all">
									<div class="panel panel-default" th:each="typeKey, stat : ${typesKeys}" th:with="itemsList=${allItemsByType.get(typeKey)}">
										<div class="panel-heading">
											<h2 class="panel-title section-title">
												<a 
													class="accordion-toggle" 
													th:classappend="${#strings.isEmpty(refreshSection) and !stat.first or !#strings.equals(refreshSection, typeKey)}? 'collapsed'" 
													role="button"
													data-toggle="collapse" 
													data-parent="#accordion_all" 
													aria-expanded="true" 
													th:attr="data-target='#section_all_'+${typeKey}, aria-controls='section_'+${typeKey}" 
												>
													<i class="fa fa-chevron-down collapsed-icon"></i>
													<span th:text="${typesMap.get(typeKey)}" /> 
												</a>
												<a class="fa fa-refresh refresh-icon" aria-hidden="true" th:href="@{/index(refreshSection=${typeKey}, sortBy=${sortBy}, treeView=false)}" role='button' th:title="#{refresh}" ></a>
											</h2>
										</div>
										<div class="panel-collapse collapse" th:classappend="${#strings.isEmpty(refreshSection) and stat.first or #strings.equals(refreshSection, typeKey)}? 'in'" th:id="|section_all_${typeKey}|">
											<div class="panel-body">
												<div th:if="${itemsList}" class="row display-flex">
													<th:block th:each="item: ${itemsList}">
														<div th:replace="fragments/driveItems :: printItem(${item})"></div>
													</th:block>
												</div>
												<div th:if="${itemsList == null}" th:text="#{container_empty}" class="sak-banner-info"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="container-view container-fluid collapse" th:classappend="${treeView}? 'in'">
							<div class="container-header">
								<h2><span th:text="#{tree_view}"/><span role="button" class="icon-toggle fa fa-toggle-on" onclick="toggleView()" th:title="#{tree_view_on}"></span></h2>
								<form th:action="@{/index}">
									<input type="hidden" name="treeView" value="true" />
									<div>
										<label th:text="#{order_by}"></label>
										<select name="sortBy" onchange="sortChanged(this)">
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:text="#{sort_by_name_ascending}" ></option>
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_NAME} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:text="#{sort_by_name_descending}"></option>
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_ASCENDING}" 
												th:text="#{sort_by_date_ascending}"></option>
											<option 
												th:value="${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:selected="${sortBy} == ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_BY_DATE} + ${T(org.sakaiproject.microsoft.mediagallery.controller.MainController).SORT_DESCENDING}" 
												th:text="#{sort_by_date_descending}"></option>
										</select>
									</div>
								</form>
							</div>
							<div class="panel-group" id="accordion_tree">
								<div class="panel panel-default" th:each="typeKey, stat : ${typesKeys}" th:with="itemsList=${itemsByType.get(typeKey)}">
									<div class="panel-heading">
										<h2 class="panel-title section-title">
											<a 
												class="accordion-toggle" 
												th:classappend="${#strings.isEmpty(refreshSection) and !stat.first or !#strings.equals(refreshSection, typeKey)}? 'collapsed'"
												role="button"
												data-toggle="collapse" 
												data-parent="#accordion_tree" 
												aria-expanded="true" 
												th:attr="data-target='#section_tree_'+${typeKey}, aria-controls='section_'+${typeKey}" 
											>
												<i class="fa fa-chevron-down collapsed-icon"></i>
												<span th:text="${typesMap.get(typeKey)}" /> 
											</a>
											<a class="fa fa-refresh refresh-icon" aria-hidden="true" th:href="@{/index(refreshSection=${typeKey}, sortBy=${sortBy}, treeView=true)}" role='button' th:title="#{refresh}" ></a>
										</h2>
									</div>
									<div class="panel-collapse collapse" th:classappend="${#strings.isEmpty(refreshSection) and stat.first or #strings.equals(refreshSection, typeKey)}? 'in'" th:id="|section_tree_${typeKey}|">
										<div class="panel-body">
											<th:block th:if="${itemsList}">
												<div th:replace="fragments/driveItems :: exploreAndPrintItems(rowId=|t_${typeKey}|, itemsList=${itemsList}, level=0)"></div>
											</th:block>
											<div th:if="${itemsList == null}" th:text="#{container_empty}" class="sak-banner-info"></div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div id="info-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="info-label" aria-hidden="true">
							<div class="modal-dialog" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<button type="button" class="close" data-dismiss="modal">
											<span aria-hidden="true">&times;</span>
										</button>
										<h4 class="modal-title b5 text-break" id="info-label"></h4>
									</div>

									<div id="body-container" class="modal-body">
									</div>

									<div class="modal-footer act">
										<button class="active" data-dismiss="modal" th:text="#{back}" th:title="#{back}"></button>
									</div>
								</div>
							</div>
						</div>

						<script>
							(function() {
								let items = document.getElementsByClassName('empty-thumbnail');

								Array.from(items).forEach((el) => {
									getThumbnail(el);
								});
							})();
						</script>
					</th:block>
				</th:block>
			</div>

			<div th:if="${firstTime}">
				<div id="loading-container" class="text-center">
					<div class="fa fa-spinner fa-spin" th:title="#{loading}"></div>
				</div>
				
				<script th:inline="javascript">
					(async function() {

						let elem = document.getElementById('body-loaded');

						let url = [[@{/items}]];

						let response = await fetch(url);
						if(!response.ok){
							showError([[#{error.items}]]);
							return;
						}
						let body = await response.text();
						if(body != ''){
							elem.innerHTML = body;
							
							document.getElementById('loading-container').classList.add('hidden');

							let items = document.getElementsByClassName('empty-thumbnail');

							Array.from(items).forEach((el) => {
								getThumbnail(el);
							});
						}
					})();
				</script>
			</div>
		</th:block>
	</body>
</html>
