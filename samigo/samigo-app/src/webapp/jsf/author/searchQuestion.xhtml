<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:t="http://myfaces.apache.org/tomahawk">

    <f:view>
        <h:head>
            <ui:fragment rendered="#{not empty requestScope['html.head']}">
                <h:outputText value="#{requestScope['html.head']}" escape="false" />
            </ui:fragment>
            <title><h:outputText value="#{authorMessages.search_question}" /></title>
            <script src="/samigo-app/js/authoring.js"></script>
            <script src="/library/webjars/jquery/1.12.4/jquery.min.js"></script>
            <script src="/library/js/spinner.js"></script>
            <script>includeWebjarLibrary('select2');</script>

            <h:outputScript>
//<![CDATA[
function textCounter(field, maxlimit) {
  if (field.value.length > maxlimit) field.value = field.value.substring(0, maxlimit);
}

function initPage() {
  disableIt();
  var importButton = document.getElementById('editform:import');
  if (importButton !== null) importButton.disabled = true;
  if ($('#editform\\:searchquestions-questions\\:importSelectAllCheck').length) {
    $('#editform\\:searchquestions-questions\\:importSelectAllCheck').focus();
  } else {
    if ('#{searchQuestionBean.lastSearchType}' == 'text') {
      var el = document.getElementById('editform:textToSearch');
      if (el) el.focus();
    } else {
      $(".tag_selector").focus();
    }
  }
}

$(document).ready(function() {
  $('#editform\\:textToSearch').keypress(function(event){
    if(event.keyCode == 13){
      $('#editform\\:searchByTextAND').click();
    }
  });
  $(".tag_selector").select2({
    width: '100%',
    language: "#{itemauthor.language}",
    closeOnSelect: false,
    ajax: {
      url: "/direct/tagservice/getTagsPaginatedByPrefixInLabel.json",
      dataType: 'json',
      delay: 500,
      data: function (params) {
        return { prefix: params.term, page: params.page };
      },
      processResults: function (data, params) {
        params.page = params.page || 1;
        return {
          results: $.map(data.data.tags, function (item) {
            return { text: item.tagLabel, description: item.tagDescription, id: item.tagId, collection: item.collectionName };
          }),
          pagination: { more: (params.page * 30) < data.data.total }
        };
      },
      cache: true
    },
    escapeMarkup: function (markup) { return markup; },
    minimumInputLength: 1,
    templateResult: formatRepo,
    templateSelection: formatRepoSelection
  });

  $('.tag_selector').on("select2:unselect", function(e){
    $('.tag_selector option').each(function() {
      if ($(this).val() == e.params.data.id) { $(this).remove(); }
    });
  }).trigger('change');
});

function formatRepo (repo) {
  return $("<span>" + repo.text + " <span class='collection'>(" + repo.collection + ")</span></span>");
}
function formatRepoSelection (repo) {
  if (typeof repo.collection != 'undefined') {
    return $("<span>" + repo.text + " <span class='collection'>(" + repo.collection + ")</span></span>");
  } else {
    return $("<span>" + repo.text + "</span>");
  }
}
//]]>
            </h:outputScript>
        </h:head>
        <h:body onload="#{empty requestScope['html.body.onload'] ? '' : requestScope['html.body.onload']}; window.onload=initPage;">
            <div class="portletBody container-fluid">
                <h:form id="editform">
                    <ui:include src="/jsf/author/allHeadings.xhtml" />
                    <h2><h:outputText value="#{authorMessages.search_question}"/></h2>

                    <h:panelGroup layout="block" styleClass="row" rendered="#{searchQuestionBean.showTags}">
                        <div class="col-xs-12 col-sm-12 col-md-12">
                            <h3><h:outputText value="#{authorMessages.tag_search}"/></h3>
                        </div>
                        <br/>
                        <div class="col-xs-12 col-md-6">
                            <select class="tag_selector" name="tag_selector[]" id="tag_selector" multiple="multiple"></select>
                        </div>
                        <br/>
                        <div class="col-xs-12 col-md-6">
                            <h:commandButton id="searchByTagAND"  action="#{searchQuestionBean.doit}"
                                             onclick="SPNR.disableControlsAndSpin(this, null);" value="#{authorMessages.button_search_questions_by_tag_and}">
                                <f:actionListener type="org.sakaiproject.tool.assessment.ui.listener.author.SearchQuestionByTag" />
                            </h:commandButton>
                            <h:commandButton id="searchByTagOR"  action="#{searchQuestionBean.doit}"
                                             onclick="SPNR.disableControlsAndSpin(this, null);" value="#{authorMessages.button_search_questions_by_tag_or}">
                                <f:actionListener type="org.sakaiproject.tool.assessment.ui.listener.author.SearchQuestionByTag" />
                            </h:commandButton>
                        </div>
                    </h:panelGroup>

                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-12">
                            <h3><h:outputText value="#{authorMessages.text_search}" /></h3>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-12"><h:outputText value="#{authorMessages.search_question_by_text_tip}" /></div>
                        <div class="col-xs-12 col-md-6">
                            <h:inputText id="textToSearch" label="#{authorMessages.text_search}" value="#{searchQuestionBean.textToSearch}"
                                         styleClass="form-control "></h:inputText>
                        </div>
                        <div class="col-xs-12 col-md-6">
                            <h:commandButton id="searchByTextAND"  action="#{searchQuestionBean.doit}"
                                             onclick="SPNR.disableControlsAndSpin(this, null);" value="#{authorMessages.button_search_questions_by_text_and}">
                                <f:actionListener type="org.sakaiproject.tool.assessment.ui.listener.author.SearchQuestionByText" />
                            </h:commandButton>
                            <h:commandButton id="searchByTextOR"  action="#{searchQuestionBean.doit}"
                                             onclick="SPNR.disableControlsAndSpin(this, null);" value="#{authorMessages.button_search_questions_by_text_or}">
                                <f:actionListener type="org.sakaiproject.tool.assessment.ui.listener.author.SearchQuestionByText" />
                            </h:commandButton>
                        </div>
                    </div>

                    <h:messages styleClass="sak-banner-error" rendered="#{! empty facesContext.maximumSeverity}" layout="table"/>

                    <h:panelGroup id="text_searched" rendered="#{searchQuestionBean.lastSearchType == 'text'}">
                        <h4><h:outputLabel value="#{authorMessages.searched_text}" />&#160;<small><h:outputLabel value="#{searchQuestionBean.textToSearch}" /></small></h4>
                        <h3><h:outputLabel value="#{authorMessages.no_results}" rendered="#{searchQuestionBean.resultsSize == 0 }"/></h3>
                    </h:panelGroup>

                    <h:panelGroup id="tags_searched" rendered="#{searchQuestionBean.lastSearchType == 'tag'}">
                        <h4><h:outputLabel value="#{authorMessages.searched_tags}"/> &#160;<small><h:outputLabel value="#{searchQuestionBean.tagToSearchLabel}" /></small></h4>
                        <h3><h:outputLabel value="#{authorMessages.no_results}" rendered="#{searchQuestionBean.resultsSize == 0 }"/></h3>
                    </h:panelGroup>

                    <h:panelGroup layout="block" rendered="#{searchQuestionBean.resultsSize > 0 }">
                        <ui:include src="/jsf/author/searchResults.xhtml" />
                    </h:panelGroup>

                    <br/>

                    <h:commandButton id="import"  action="#{searchQuestionBean.doit}"
                                     onclick="SPNR.disableControlsAndSpin(this, null);" value="#{authorMessages.button_add_questions}">
                        <f:actionListener type="org.sakaiproject.tool.assessment.ui.listener.author.ImportQuestionsToAuthoringFromSearch" />
                    </h:commandButton>

                    <h:commandButton style="act" value="#{commonMessages.cancel_action}" action="#{searchQuestionBean.cancelSearchQuestion}" onclick="SPNR.disableControlsAndSpin(this, null);">
                        <f:actionListener type="org.sakaiproject.tool.assessment.ui.listener.author.CancelSearchQuestion" />
                    </h:commandButton>

                </h:form>
            </div>
        </h:body>
    </f:view>
</ui:composition>
