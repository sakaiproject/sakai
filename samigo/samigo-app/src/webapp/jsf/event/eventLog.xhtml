<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <f:view>
        <h:head>
            <ui:fragment rendered="#{not empty requestScope['html.head']}">
                <h:outputText value="#{requestScope['html.head']}" escape="false" />
            </ui:fragment>
            <title>
                <h:outputText value="EventLog" />
            </title>
            <script>
                includeWebjarLibrary('datatables');
            </script>
            <script>
                includeWebjarLibrary('datatables-plugins');
            </script>
            <script src="/samigo-app/js/delivery.js"></script>
            <script src="/samigo-app/js/eventInfo.js"></script>
            <script src="/samigo-app/js/sortHelper.js"></script>
            <script src="/samigo-app/js/dataTables.js"></script>
        </h:head>

        <h:body onload="#{empty requestScope['html.body.onload'] ? '' : requestScope['html.body.onload']};">
            <div class="portletBody container-fluid">
                <h:form id="eventLogId">
                    <ui:include src="/jsf/event/eventLogHeadings.xhtml" />

                    <h:messages rendered="#{facesContext.maximumSeverity ne null}"
                        infoClass="validation" warnClass="validation" errorClass="validation"
                        fatalClass="validation" />

                    <div class="page-header">
                        <h1>
                            <h:outputText value="#{eventLogMessages.log}" />
                        </h1>
                    </div>

                    <h:panelGroup styleClass="d-flex justify-content-between align-items-center flex-wrap gap-1 mb-1"
                        layout="block" rendered="#{not empty eventLog.eventLogDataList}">
                        <h:panelGroup styleClass="d-flex flex-wrap flex-sm-nowrap align-items-center"
                            layout="block">
                            <h:outputLabel styleClass="text-nowrap" value="#{eventLogMessages.filterBy}" />
                            <h:outputText value="&#160;" escape="false" />
                            <h:selectOneMenu styleClass="form-select form-select-sm"
                                value="#{eventLog.filteredAssessmentId}" id="assessmentTitle" required="true"
                                onchange="document.forms[0].submit();">
                                <f:selectItems value="#{eventLog.assessments}" />
                                <f:valueChangeListener
                                    type="org.sakaiproject.tool.assessment.ui.listener.author.EventLogListener" />
                            </h:selectOneMenu>
                        </h:panelGroup>
                        <h:outputLink styleClass="button" value="#{eventLog.exportUrl}">
                            <h:outputText value="#{eventLogMessages.export_csv}" />
                        </h:outputLink>
                    </h:panelGroup>

                    <script type="application/json" id="event-log-config">
                        <h:outputText value="#{eventLog.dataTableConfig.json}" escape="false" />
                    </script>
                    <script>
                        //<![CDATA[
                        const deletedText = '<h:outputText value="#{eventLogMessages.assessment_deleted}" />';
                        document.addEventListener("DOMContentLoaded", () => {
                            const configElement = document.getElementById("event-log-config");
                            if (configElement) {
                                const dataTableConfig = JSON.parse(configElement.textContent);
                                setupDataTable("eventLogId:eventLogTable", dataTableConfig);
                            }
                        });
                        //]]>
                    </script>

                    <div class="table">
                        <h:dataTable style="display:none;" id="eventLogTable"
                            styleClass="table table-striped table-bordered"
                            value="#{eventLog.eventLogDataList}"
                            rendered="#{not empty eventLog.eventLogDataList}" var="log">

                            <h:column>
                                <f:facet name="header">
                                    <h:outputText value="#{eventLogMessages.title}" />
                                </f:facet>

                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.title}" />
                                    <h:outputText value="#{eventLogMessages.assessment_deleted}"
                                        rendered="#{eventLog.isDeleted(log.assessmentId)}" />
                                </h:panelGroup>
                            </h:column>

                            <h:column>
                                <f:facet name="header">
                                    <h:outputText value="#{eventLogMessages.id}" />
                                </f:facet>
                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.assessmentIdStr}" />
                                </h:panelGroup>
                            </h:column>

                            <h:column>
                                <f:facet name="header">
                                    <h:outputText value="#{eventLogMessages.user_id}" />
                                </f:facet>

                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.userDisplay}" />
                                </h:panelGroup>
                            </h:column>

                            <h:column>
                                <f:facet name="header">
                                    <h:outputText value="#{eventLogMessages.date_startd}" />
                                </f:facet>

                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.startDate}">
                                        <f:convertDateTime dateStyle="medium" timeStyle="short"
                                            timeZone="#{author.userTimeZone}" />
                                    </h:outputText>
                                    <h:outputText value="#{log.startDate}" styleClass="hidden spanValue">
                                        <f:convertDateTime pattern="yyyyMMddHHmmss" />
                                    </h:outputText>
                                </h:panelGroup>
                            </h:column>

                            <h:column>
                                <f:facet name="header">
                                    <h:outputText id="eventLogTable" value="#{eventLogMessages.date_submitted}" />
                                </f:facet>

                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.endDate}">
                                        <f:convertDateTime dateStyle="medium" timeStyle="short"
                                            timeZone="#{author.userTimeZone}" />
                                    </h:outputText>
                                    <h:outputText value="#{log.endDate}" styleClass="hidden spanValue">
                                        <f:convertDateTime pattern="yyyyMMddHHmmss" />
                                    </h:outputText>
                                </h:panelGroup>
                            </h:column>

                            <h:column>
                                <f:facet name="header">
                                    <h:outputText value="#{eventLogMessages.duration}" />
                                </f:facet>

                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.eclipseTime}" />
                                    <h:outputText value=" " />
                                    <h:outputText value="#{eventLogMessages.minutes}"
                                        rendered="#{log.eclipseTime > 1}" />
                                    <h:outputText value="#{eventLogMessages.minute}"
                                        rendered="#{log.eclipseTime lt 2}" />
                                </h:panelGroup>
                            </h:column>

                            <h:column>
                                <f:facet name="header">
                                    <h:outputText value="#{eventLogMessages.errors}" />
                                </f:facet>

                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.errorMsg}" rendered="#{!log.isNoErrors}">
                                        <f:converter converterId="org.sakaiproject.tool.assessment.jsf.convert.EventLogConverter" />
                                    </h:outputText>
                                    <h:outputText value="#{log.errorMsg}" styleClass="text-muted"
                                        rendered="#{log.isNoErrors}">
                                        <f:converter converterId="org.sakaiproject.tool.assessment.jsf.convert.EventLogConverter" />
                                    </h:outputText>
                                </h:panelGroup>
                            </h:column>

                            <h:column rendered="#{eventLog.enabledIpAddress}">
                                <f:facet name="header">
                                    <h:outputText value="#{eventLogMessages.ipAddress}" />
                                </f:facet>

                                <h:panelGroup styleClass="#{eventLog.isDeleted(log.assessmentId) ? 'eventLogDeleted' : ''}">
                                    <h:outputText value="#{log.ipAddress}" />
                                </h:panelGroup>
                            </h:column>

                        </h:dataTable>

                        <h:panelGroup styleClass="sak-banner-info"
                            rendered="#{empty eventLog.eventLogDataList}" layout="block">
                            <h:outputText value="#{eventLogMessages.no_data}" />
                        </h:panelGroup>
                    </div>
                </h:form>
            </div>
        </h:body>
    </f:view>
</ui:composition>
