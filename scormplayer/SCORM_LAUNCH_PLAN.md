# SCORM Launch Modernization Plan

## Scope
- Keep existing Wicket flows for SCORM package upload, configuration, and reporting (`scormplayer/scorm-tool/ui/console` and `.../ui/reporting`).
- Replace the launch experience managed by `ScormPlayerPage`, `LazyLaunchPanel`, `LaunchPanel`, and the SJAX layer (`SjaxContainer`, `scorm-sjax.js`).
- Preserve SCORM 2004 compliance using the current service implementations (`ScormApplicationService`, `ScormSequencingService`, `ScormResultService`, `LearningManagementSystem`).

## Target Architecture
- Wicket continues to gate access and render the launch surface, providing initial parameters and authorization.
- The launch surface becomes a lightweight page that hosts either a Lit-based `<scorm-launcher>` component or a vanilla ES module shell; Wicket only injects data.
- Runtime communication shifts to REST endpoints in the `webapi` module, eliminating the hidden form + SJAX pattern while keeping sequencing logic server-side.
- Active launch sessions are tracked via a new session registry that wraps existing `SessionBean` instances and enforces per-user/site permissions.

## Frontend Launch Flow
- **Bootstrap**: On page load, initialize the component with a signed payload or short-lived token generated by Wicket.
- **Session creation**: Call `POST /api/scorm/sessions` to create/resume a session; response includes `sessionId`, attempt metadata, sequencing state flags, TOC data, and SCO launch URLs.
- **Rendering**: Display SCORM content within a responsive `<iframe>`; use Bootstrap 5 helpers and `ResizeObserver` instead of legacy resize scripts.
- **Runtime bridge**: Provide a standards-compliant `window.API_1484_11` implementation that forwards `Initialize`, `Terminate`, `GetValue`, `SetValue`, `Commit`, `GetLastError`, `GetErrorString`, and `GetDiagnostic` to REST endpoints using `fetch`.
- **Navigation events**: Map TOC interactions and SCO `postMessage` events to sequencing operations via dedicated REST calls.
- **Completion**: After successful `Terminate`, redirect to the existing completion URL supplied by Wicket; handle error states with Bootstrap alerts and localized messages.

## Backend REST Design (webapi)
- Add `ScormController` under `webapi/src/main/java/org/sakaiproject/webapi/controllers`.
- Endpoints (no explicit versioning to match current webapi conventions):
  - `POST /api/scorm/sessions` → create or resume a session via `ScormSequencingService.newSessionBean`; compute attempt/resume logic mirroring `LazyLaunchPanel`.
  - `POST /api/scorm/sessions/{sessionId}/nav` → process navigation requests (`SeqNavRequests` enums) and return updated session state + next SCO URL.
  - `POST /api/scorm/sessions/{sessionId}/runtime` → accept `{ "method": "Initialize", "args": [...] }` payloads, delegate to `ScormApplicationService`, respond with SCORM result + error metadata.
  - `GET /api/scorm/sessions/{sessionId}/resource` → return signed or tokenized launch URLs for the current SCO via `ScormResourceService`.
  - `DELETE /api/scorm/sessions/{sessionId}` → finalize session cleanup after `Terminate`, ensuring Gradebook synchronization.
- Introduce a `ScormLaunchSessionRegistry` bean (likely in `scormplayer/scorm-impl/service`) to store active `SessionBean`s keyed by secure random tokens, expiring via `SessionManager`.
- Ensure permission checks with `SecurityService` and `LearningManagementSystem.canLaunchAttempt` before allowing session creation or sequencing requests.
- Provide DTOs for session state and TOC serialization; convert the `TreeModel` to JSON, optionally lazy-loading branches via an additional `GET /api/scorm/sessions/{sessionId}/toc?node=...` route if needed.
- Document new API endpoints in `webapi/src/main/asciidoc` and align with existing OpenAPI generation (if applicable).

## Integration Strategy
- **Phase 1 – Services**: Implement session registry and REST controller, with Spring MVC tests validating each endpoint against mocked services and existing `SCORM13APITest` expectations.
- **Phase 2 – Frontend shell**: Build `<scorm-launcher>` (or equivalent) in `webcomponents/tool/src/main/frontend`, wiring to the new endpoints; provide a single ES module implementation bundled via `npm run bundle`.
- **Phase 3 – Replace launch view**: Update the Wicket launch page to render only the new component, removing the legacy SJAX scaffolding from `ScormPlayerPage`.
- **Phase 4 – Cleanup**: Delete obsolete Wicket components (`LaunchPanel`, `SjaxContainer`, etc.), remove `scorm-sjax.js`, and prune unused Spring beans once rest-based launch is fully deployed.

## Testing & Compliance
- Extend existing automated tests (`scormplayer/scorm-tool/src/test/.../SCORM13APITest.java`) to call the REST endpoints, verifying Initialize/Terminate flows, suspend/resume, and error reporting.
- Add integration tests covering Gradebook synchronization via `ScormApplicationService.synchResultWithGradebook`.
- Perform manual QA with representative SCORM 2004 packages (multi-SCO sequencing, mastery score rules, suspend/resume) across Chrome, Firefox, Edge, and Safari (desktop + PWA on iOS).
- Validate accessibility (keyboard navigation in TOC, focus management within iframe) and responsive layout against Bootstrap 5 guidelines.

## Risks & Mitigations
- **Session state drift**: Protect registry updates with synchronized access or use `ConcurrentHashMap` + per-session locks.
- **Large TOC payloads**: Support incremental loading of deep trees and cache frequently accessed nodes.
- **Cross-origin issues**: Serve SCO assets under the same origin where possible; otherwise configure `postMessage` handshake and appropriate CSP headers.
- **Legacy dependencies**: Removing Wicket launch components may surface hidden coupling; mitigate by auditing references before deletion and ensuring automated tests cover sequencing flows.

## Immediate Next Steps
- Prototype the session registry and REST controller wiring in a feature branch; confirm bean configuration in `scormplayer/scorm-tool/src/webapp/WEB-INF/applicationContext.xml`.
- Draft the `<scorm-launcher>` component scaffold and verify data exchange with stubbed REST responses.
- Define QA checklist and coordinate sequencing/Gradebook regression coverage prior to rollout in shared environments.
